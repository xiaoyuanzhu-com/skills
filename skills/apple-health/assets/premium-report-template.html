<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Health Assessment</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:#08090c;color:#a0a4b0;font-family:'SF Pro Display',-apple-system,'Inter','Helvetica Neue',sans-serif;
  line-height:1.6;min-height:100vh}
.report-wrap{max-width:1100px;margin:0 auto;padding:48px 28px 96px}

/* Typography */
h1{font-size:2.2rem;font-weight:300;color:#d0d3de;letter-spacing:-.01em}
h2{font-size:1.4rem;font-weight:500;color:#d0d3de;margin-bottom:10px;letter-spacing:.02em}
h3{font-size:1.05rem;font-weight:500;color:#b0b4c0;margin-bottom:12px}
h4{font-size:.82rem;font-weight:400;color:#6b7080;letter-spacing:.02em;margin-bottom:10px}

/* Section layout */
.section{padding:56px 0;border-bottom:1px solid #1c1e26}
.section:last-child{border-bottom:none}
.section-header{margin-bottom:36px}
.section-header h2{position:relative;display:inline-block;padding-bottom:12px}
.section-header h2::after{content:'';position:absolute;bottom:0;left:0;width:100%;height:1px;
  background:#1c1e26}
.section-subtitle{color:#6b7080;font-size:.88rem;margin-top:6px}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;margin-bottom:28px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:28px}

/* Card */
.card{background:#111318;border:1px solid #1c1e26;border-radius:14px;padding:28px;transition:border-color .2s}
.card:hover{border-color:#2a2d38}
.card.wide{grid-column:1/-1}
.card.accent-top{border-top:2px solid #7c83db}

/* Big numbers */
.big-num{font-size:2.4rem;font-weight:300;color:#d0d3de;line-height:1.1;letter-spacing:-.01em}
.big-num small{font-size:.85rem;font-weight:400;color:#6b7080;margin-left:4px}
.label{font-size:.78rem;color:#6b7080;letter-spacing:.02em;margin-bottom:4px}

/* Trend badges */
.trend{display:inline-flex;align-items:center;gap:4px;font-size:.72rem;font-weight:400;padding:2px 8px;border-radius:20px;margin-left:8px}
.trend.up{background:rgba(107,163,122,.1);color:#6ba37a}
.trend.down{background:rgba(179,107,107,.1);color:#b36b6b}
.trend.flat{background:rgba(90,96,112,.1);color:#5a6070}
.trend.warn{background:rgba(196,160,78,.1);color:#c4a04e}

/* Stats row */
.stats-row{display:flex;flex-wrap:wrap;gap:28px;margin:18px 0}
.stat-item{flex:1;min-width:80px}
.stat-value{font-size:1.2rem;font-weight:400;color:#d0d3de}
.stat-label{font-size:.72rem;color:#6b7080;letter-spacing:.02em}

/* Percentile bar */
.pctl-bar{height:4px;background:#1c1e26;border-radius:2px;position:relative;margin:10px 0}
.pctl-fill{height:100%;border-radius:2px;background:#7c83db}
.pctl-marker{position:absolute;top:-4px;width:2px;height:12px;background:#d0d3de;border-radius:1px;transform:translateX(-50%)}
.pctl-labels{display:flex;justify-content:space-between;font-size:.65rem;color:#5a6070}

/* Knowledge panel */
.knowledge-panel{background:#0d0e14;border:1px solid #1c1e26;border-left:2px solid #2a2d38;border-radius:0 10px 10px 0;
  padding:18px 22px;margin-top:20px;font-size:.82rem;color:#7b8090;line-height:1.7}
.knowledge-panel strong{color:#a0a4b0;font-weight:500}
.knowledge-panel .kp-title{font-size:.72rem;letter-spacing:.02em;color:#6b7080;font-weight:500;margin-bottom:8px}

/* Legend */
.legend{display:flex;flex-wrap:wrap;gap:16px;margin:12px 0}
.legend-item{display:flex;align-items:center;gap:6px;font-size:.75rem;color:#7b8090}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* SVG chart containers */
.chart-container{width:100%;overflow:visible}
.chart-container svg{width:100%;display:block}

/* Methodology */
.meth-item{display:flex;gap:14px;padding:10px 0;border-bottom:1px solid #1c1e26;font-size:.85rem}
.meth-item:last-child{border-bottom:none}
.meth-label{color:#6b7080;min-width:140px}
.meth-value{color:#a0a4b0}

/* Correlation matrix cell */
.corr-cell{display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:500}

/* Scrollable table */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.data-table{width:100%;border-collapse:collapse;font-size:.82rem}
table.data-table th{text-align:left;padding:12px 14px;color:#6b7080;font-weight:400;border-bottom:1px solid #1c1e26;
  font-size:.72rem;letter-spacing:.02em}
table.data-table td{padding:12px 14px;border-bottom:1px solid #14151c}

/* Print */
@media print{
  body{background:#fff;color:#222}
  .report-wrap{padding:20px}
  .card{background:#f8f8fa;border:1px solid #ddd;break-inside:avoid}
  .section{padding:24px 0}
  .knowledge-panel{background:#f0f0ff;border-color:#ddd;border-left-color:#7c83db;color:#444}
  .big-num{color:#111}
  h1,h2,h3{color:#111}
  .stat-value{color:#111}
  .label,.stat-label{color:#666}
  .section-header h2::after{background:#7c83db}
}

/* Responsive */
@media(max-width:768px){
  .report-wrap{padding:24px 18px 72px}
  h1{font-size:1.6rem}
  h2{font-size:1.2rem}
  .grid,.grid-2,.grid-3{grid-template-columns:1fr}
  .big-num{font-size:1.8rem}
  .stats-row{gap:18px}
  .section{padding:36px 0}
}
</style>
</head>
<body>
<!--DATA_INJECTION-->
<div class="report-wrap" id="app"></div>
<script>
(function(){
"use strict";
var D = window.__DATA__ || {};
var MODE = window.__MODE__ || "report";
var app = document.getElementById("app");

/* =============================================
   COLORS
   ============================================= */
var COLORS = {
  primary: '#7c83db',
  secondary: '#9b8ec4',
  success: '#6ba37a',
  warning: '#c4a04e',
  danger: '#b36b6b',
  info: '#6b9aba',
  muted: '#5a6070',
  sleep: {deep:'#5b6abf',core:'#4e7da8',rem:'#7b6ba3',awake:'#4a4f5e'},
  heatmap: ['#1a1c24','#1e2a3d','#2a4066','#3d5a8a','#5277aa','#6b94c4'],
  correlation: {negative:'#b36b6b',zero:'#1e1e2e',positive:'#5b6abf'},
  radar: {fill:'rgba(124,131,219,0.12)',stroke:'#7c83db'},
  accent1: '#7c83db',
  accent2: '#6b9aba',
  accent3: '#9b8ec4',
  accent4: '#6ba37a'
};

/* =============================================
   UTILITIES
   ============================================= */
function el(tag, attrs, children) {
  var e = document.createElement(tag);
  if (attrs) Object.keys(attrs).forEach(function(k) {
    if (k==='className') e.className=attrs[k];
    else if (k==='innerHTML') e.innerHTML=attrs[k];
    else if (k==='textContent') e.textContent=attrs[k];
    else if (k==='style'&&typeof attrs[k]==='object') Object.assign(e.style,attrs[k]);
    else e.setAttribute(k,attrs[k]);
  });
  if (children) {
    if (!Array.isArray(children)) children=[children];
    children.forEach(function(c){
      if (typeof c==='string') e.appendChild(document.createTextNode(c));
      else if (c) e.appendChild(c);
    });
  }
  return e;
}

function svgEl(tag, attrs) {
  var e = document.createElementNS("http://www.w3.org/2000/svg", tag);
  if (attrs) Object.keys(attrs).forEach(function(k){ e.setAttribute(k, attrs[k]); });
  return e;
}

function fmt(v, dec) {
  if (v == null || isNaN(v)) return "--";
  if (dec === 0) return Math.round(v).toLocaleString();
  return Number(v).toFixed(dec == null ? 1 : dec);
}

function pct(v) { return v == null ? "--" : fmt(v,1)+"%"; }

function section(id) {
  var s = el("div", {className:"section", id:id});
  app.appendChild(s);
  return s;
}

function sectionHeader(container, title, subtitle) {
  var h = el("div", {className:"section-header"});
  h.appendChild(el("h2", {textContent:title}));
  if (subtitle) h.appendChild(el("div", {className:"section-subtitle",textContent:subtitle}));
  container.appendChild(h);
}

function card(titleText, bodyEls, cls) {
  var c = el("div", {className:"card"+(cls?" "+cls:"")});
  if (titleText) c.appendChild(el("h4", {textContent:titleText}));
  if (bodyEls) {
    if (!Array.isArray(bodyEls)) bodyEls=[bodyEls];
    bodyEls.forEach(function(b){ if(b) c.appendChild(b); });
  }
  return c;
}

function bigNum(value, unit, trendDir, trendText) {
  var wrap = el("div");
  var num = el("div", {className:"big-num"});
  num.appendChild(document.createTextNode(value));
  if (unit) num.appendChild(el("small", {textContent:" "+unit}));
  if (trendDir) {
    var badge = el("span", {className:"trend "+trendDir, textContent:trendText||trendDir});
    num.appendChild(badge);
  }
  wrap.appendChild(num);
  return wrap;
}

function legendRow(items) {
  var wrap = el("div", {className:"legend"});
  items.forEach(function(it){
    var item = el("div", {className:"legend-item"});
    item.appendChild(el("div", {className:"legend-dot", style:{background:it.color}}));
    item.appendChild(el("span", {textContent:it.label}));
    wrap.appendChild(item);
  });
  return wrap;
}

function trendArrow(dir) {
  if (dir === 'up' || dir === 'improving') return '\u2191';
  if (dir === 'down' || dir === 'declining') return '\u2193';
  return '\u2192';
}

function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

function lerp(a, b, t) { return a + (b - a) * t; }

function colorInterp(r1,g1,b1, r2,g2,b2, t) {
  return 'rgb('+Math.round(lerp(r1,r2,t))+','+Math.round(lerp(g1,g2,t))+','+Math.round(lerp(b1,b2,t))+')';
}

function corrColor(r) {
  if (r < 0) return colorInterp(179,107,107, 30,30,46, 1+r);
  return colorInterp(30,30,46, 91,106,191, r);
}

function heatColor(v, mn, mx) {
  var t = mx===mn ? 0 : clamp((v-mn)/(mx-mn),0,1);
  var idx = Math.min(Math.floor(t * COLORS.heatmap.length), COLORS.heatmap.length-1);
  return COLORS.heatmap[idx];
}

/* =============================================
   CHART 1: RADAR CHART
   ============================================= */
function radarChart(container, axes, opts) {
  opts = opts || {};
  var size = opts.size || 280;
  var cx = size/2, cy = size/2, R = size/2 - 40;
  var n = axes.length;
  if (n < 3) return;
  var svg = svgEl("svg", {viewBox:"0 0 "+size+" "+size, width:size, height:size});
  svg.style.display = "block";
  svg.style.margin = "0 auto";
  var maxVal = opts.maxVal || 5;

  // Grid rings
  [0.2,0.4,0.6,0.8,1.0].forEach(function(ring){
    var pts = [];
    for (var i=0;i<n;i++){
      var angle = (Math.PI*2*i/n) - Math.PI/2;
      pts.push((cx + Math.cos(angle)*R*ring).toFixed(1)+","+(cy + Math.sin(angle)*R*ring).toFixed(1));
    }
    svg.appendChild(svgEl("polygon", {points:pts.join(" "), fill:"none", stroke:"#1c1e26", "stroke-width":"1"}));
  });

  // Spokes + labels
  for (var i=0;i<n;i++){
    var angle = (Math.PI*2*i/n) - Math.PI/2;
    var ex = cx + Math.cos(angle)*R;
    var ey = cy + Math.sin(angle)*R;
    svg.appendChild(svgEl("line", {x1:cx,y1:cy,x2:ex,y2:ey, stroke:"#1c1e26", "stroke-width":"1"}));
    var lx = cx + Math.cos(angle)*(R+20);
    var ly = cy + Math.sin(angle)*(R+20);
    var txt = svgEl("text", {x:lx, y:ly, fill:"#7b8090", "font-size":"11", "text-anchor":"middle", "dominant-baseline":"middle"});
    txt.textContent = axes[i].label;
    svg.appendChild(txt);
  }

  // Data polygon
  var dataPts = [];
  for (var i=0;i<n;i++){
    var angle = (Math.PI*2*i/n) - Math.PI/2;
    var v = clamp(axes[i].value/maxVal, 0, 1);
    dataPts.push((cx + Math.cos(angle)*R*v).toFixed(1)+","+(cy + Math.sin(angle)*R*v).toFixed(1));
  }
  svg.appendChild(svgEl("polygon", {points:dataPts.join(" "), fill:opts.fill||COLORS.radar.fill,
    stroke:opts.stroke||COLORS.radar.stroke, "stroke-width":"2"}));

  // Data dots
  for (var i=0;i<n;i++){
    var angle = (Math.PI*2*i/n) - Math.PI/2;
    var v = clamp(axes[i].value/maxVal, 0, 1);
    var dx = cx + Math.cos(angle)*R*v;
    var dy = cy + Math.sin(angle)*R*v;
    svg.appendChild(svgEl("circle", {cx:dx, cy:dy, r:"4", fill:opts.stroke||COLORS.radar.stroke}));
  }

  container.appendChild(svg);
}

/* =============================================
   CHART 2: SPARKLINE
   ============================================= */
function sparkline(container, values, opts) {
  opts = opts || {};
  var w = opts.width || 120, h = opts.height || 32;
  if (!values || values.length < 2) return;
  var vals = values.filter(function(v){return v!=null});
  if (vals.length < 2) return;
  var mn = Math.min.apply(null, vals), mx = Math.max.apply(null, vals);
  if (mn === mx) { mn -= 1; mx += 1; }
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, width:w, height:h});
  svg.style.display = "inline-block";
  svg.style.verticalAlign = "middle";
  var pad = 2;
  var pts = [];
  vals.forEach(function(v, i){
    var x = pad + (i/(vals.length-1))*(w-pad*2);
    var y = h - pad - ((v-mn)/(mx-mn))*(h-pad*2);
    pts.push(x.toFixed(1)+","+y.toFixed(1));
  });
  // Area fill
  var areaPath = "M"+pts[0]+" "+pts.join(" L")+" L"+(w-pad)+","+(h-pad)+" L"+pad+","+(h-pad)+" Z";
  svg.appendChild(svgEl("path", {d:areaPath, fill:(opts.color||COLORS.primary), opacity:"0.15"}));
  svg.appendChild(svgEl("polyline", {points:pts.join(" "), fill:"none", stroke:opts.color||COLORS.primary,
    "stroke-width":"1.5", "stroke-linecap":"round", "stroke-linejoin":"round"}));
  container.appendChild(svg);
}

/* =============================================
   CHART 3: BULLET CHART
   ============================================= */
function bulletChart(container, data, opts) {
  opts = opts || {};
  var w = 300, h = 40;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, width:"100%", height:h});
  svg.style.display = "block";
  var mn = data.min != null ? data.min : 0;
  var mx = data.max != null ? data.max : 100;
  var range = mx - mn || 1;
  var barY = 12, barH = 16;
  var pad = 4;
  var usableW = w - pad*2;

  // Background ranges (tertiles)
  svg.appendChild(svgEl("rect", {x:pad, y:barY, width:usableW, height:barH, rx:"4", fill:"#1c1e26"}));
  svg.appendChild(svgEl("rect", {x:pad, y:barY, width:usableW*0.66, height:barH, rx:"4", fill:"#181a24"}));
  svg.appendChild(svgEl("rect", {x:pad, y:barY, width:usableW*0.33, height:barH, rx:"4", fill:"#14161e"}));

  // Current value bar
  var valW = clamp((data.value-mn)/range, 0, 1) * usableW;
  svg.appendChild(svgEl("rect", {x:pad, y:barY+3, width:Math.max(2,valW), height:barH-6, rx:"3",
    fill:opts.color||COLORS.primary}));

  // Previous marker
  if (data.previous != null) {
    var prevX = pad + clamp((data.previous-mn)/range, 0, 1) * usableW;
    svg.appendChild(svgEl("line", {x1:prevX, y1:barY-2, x2:prevX, y2:barY+barH+2,
      stroke:"#d0d3de", "stroke-width":"2", opacity:"0.6"}));
  }

  // Label
  if (opts.label) {
    var lbl = svgEl("text", {x:pad, y:9, fill:"#7b8090", "font-size":"10"});
    lbl.textContent = opts.label;
    svg.appendChild(lbl);
  }

  // Value text
  var vt = svgEl("text", {x:Math.max(pad+valW+6, pad+20), y:barY+barH/2+4, fill:"#d0d3de", "font-size":"11", "font-weight":"500"});
  vt.textContent = fmt(data.value, opts.decimals != null ? opts.decimals : 1);
  svg.appendChild(vt);

  container.appendChild(svg);
}

/* =============================================
   CHART 4: AREA CHART
   ============================================= */
function areaChart(container, data, opts) {
  opts = opts || {};
  var w = 600, h = opts.height || 160;
  var pad = {top:10, right:10, bottom:24, left:40};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%";
  svg.style.display = "block";

  var dates = data.dates || [];
  var values = data.values || [];
  if (values.length === 0) return;

  var validVals = values.filter(function(v){return v!=null});
  var mn = opts.yMin != null ? opts.yMin : Math.min.apply(null, validVals);
  var mx = opts.yMax != null ? opts.yMax : Math.max.apply(null, validVals);
  if (mn===mx){mn-=1;mx+=1;}
  var range = mx - mn;

  function xPos(i) { return pad.left + (i/(Math.max(1,values.length-1)))*cw; }
  function yPos(v) { return pad.top + ch - ((v-mn)/range)*ch; }

  // Y gridlines
  var nGrid = 4;
  for (var g=0;g<=nGrid;g++){
    var gy = pad.top + (g/nGrid)*ch;
    var gv = mx - (g/nGrid)*range;
    svg.appendChild(svgEl("line", {x1:pad.left, y1:gy, x2:w-pad.right, y2:gy, stroke:"#1c1e26", "stroke-width":"1"}));
    var yt = svgEl("text", {x:pad.left-6, y:gy+4, fill:"#5a6070", "font-size":"9", "text-anchor":"end"});
    yt.textContent = fmt(gv, opts.yDecimals != null ? opts.yDecimals : 0);
    svg.appendChild(yt);
  }

  // Build main area + line
  var pts = [];
  var firstI = -1, lastI = -1;
  for (var i=0;i<values.length;i++){
    if (values[i]!=null){
      pts.push({x:xPos(i), y:yPos(values[i])});
      if (firstI===-1) firstI=i;
      lastI=i;
    }
  }
  if (pts.length > 1) {
    var lineStr = pts.map(function(p){return p.x.toFixed(1)+","+p.y.toFixed(1)}).join(" ");
    var areaStr = "M"+pts[0].x.toFixed(1)+","+pts[0].y.toFixed(1)+" "+
      pts.map(function(p){return "L"+p.x.toFixed(1)+","+p.y.toFixed(1)}).join(" ")+
      " L"+pts[pts.length-1].x.toFixed(1)+","+(pad.top+ch)+" L"+pts[0].x.toFixed(1)+","+(pad.top+ch)+" Z";
    svg.appendChild(svgEl("path", {d:areaStr, fill:opts.color||COLORS.primary, opacity:"0.12"}));
    svg.appendChild(svgEl("polyline", {points:lineStr, fill:"none", stroke:opts.color||COLORS.primary,
      "stroke-width":"2", "stroke-linecap":"round", "stroke-linejoin":"round"}));
  }

  // Rolling average overlay
  var ra = data.rolling_avg || data.rolling_7d;
  if (ra && ra.length) {
    var raPts = [];
    for (var i=0;i<ra.length;i++){
      if (ra[i]!=null) raPts.push(xPos(i).toFixed(1)+","+yPos(ra[i]).toFixed(1));
    }
    if (raPts.length > 1) {
      svg.appendChild(svgEl("polyline", {points:raPts.join(" "), fill:"none",
        stroke:opts.rollingColor||"#c4a04e", "stroke-width":"2", "stroke-dasharray":"4,3",
        "stroke-linecap":"round", "stroke-linejoin":"round", opacity:"0.8"}));
    }
  }

  // X labels (show ~6)
  if (dates.length > 0) {
    var step = Math.max(1, Math.floor(dates.length/6));
    for (var i=0;i<dates.length;i+=step){
      var lbl = dates[i] ? dates[i].slice(5) : "";
      var xt = svgEl("text", {x:xPos(i), y:h-4, fill:"#5a6070", "font-size":"9", "text-anchor":"middle"});
      xt.textContent = lbl;
      svg.appendChild(xt);
    }
  }

  // Tooltip dots (every point has a title)
  pts.forEach(function(p, idx){
    var c = svgEl("circle", {cx:p.x, cy:p.y, r:"0", fill:opts.color||COLORS.primary, opacity:"0"});
    svg.appendChild(c);
  });

  container.appendChild(svg);
}

/* =============================================
   CHART 5: STACKED AREA
   ============================================= */
function stackedArea(container, series, opts) {
  opts = opts || {};
  var w = 600, h = opts.height || 160;
  var pad = {top:10, right:10, bottom:24, left:40};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";

  var dates = opts.dates || [];
  var n = dates.length || (series[0] && series[0].values ? series[0].values.length : 0);
  if (n === 0) return;

  // Compute stacked totals
  var totals = [];
  for (var i=0;i<n;i++){
    var sum = 0;
    series.forEach(function(s){ sum += (s.values[i]||0); });
    totals.push(sum);
  }
  var mx = Math.max.apply(null, totals) || 100;

  function xPos(i){ return pad.left + (i/(Math.max(1,n-1)))*cw; }
  function yPos(v){ return pad.top + ch - (v/mx)*ch; }

  // Draw from bottom up
  var baseline = new Array(n);
  for (var i=0;i<n;i++) baseline[i] = 0;

  for (var si = series.length-1; si>=0; si--) {
    var s = series[si];
    var topPts = [], botPts = [];
    for (var i=0;i<n;i++){
      var bot = baseline[i];
      var top = bot + (s.values[i]||0);
      topPts.push(xPos(i).toFixed(1)+","+yPos(top).toFixed(1));
      botPts.unshift(xPos(i).toFixed(1)+","+yPos(bot).toFixed(1));
    }
    var pathD = "M"+topPts.join(" L")+" L"+botPts.join(" L")+" Z";
    svg.appendChild(svgEl("path", {d:pathD, fill:s.color||COLORS.primary, opacity:"0.7"}));
    // Update baseline
    for (var i=0;i<n;i++) baseline[i] += (s.values[i]||0);
  }

  // X labels
  if (dates.length > 0) {
    var step = Math.max(1, Math.floor(dates.length/6));
    for (var i=0;i<dates.length;i+=step){
      var xt = svgEl("text", {x:xPos(i), y:h-4, fill:"#5a6070", "font-size":"9", "text-anchor":"middle"});
      xt.textContent = (dates[i]||"").slice(5);
      svg.appendChild(xt);
    }
  }

  container.appendChild(svg);
}

/* =============================================
   CHART 6: DONUT CHART
   ============================================= */
function donutChart(container, slices, opts) {
  opts = opts || {};
  var size = opts.size || 200;
  var cx = size/2, cy = size/2;
  var outerR = size/2 - 10, innerR = outerR * 0.62;
  var svg = svgEl("svg", {viewBox:"0 0 "+size+" "+size, width:size, height:size});
  svg.style.display = "block";
  svg.style.margin = "0 auto";

  var total = 0;
  slices.forEach(function(s){ total += (s.value||0); });
  if (total === 0) return;

  var startAngle = -Math.PI/2;
  slices.forEach(function(s){
    var frac = (s.value||0)/total;
    var endAngle = startAngle + frac * Math.PI * 2;
    var largeArc = frac > 0.5 ? 1 : 0;

    var x1o = cx + Math.cos(startAngle)*outerR;
    var y1o = cy + Math.sin(startAngle)*outerR;
    var x2o = cx + Math.cos(endAngle)*outerR;
    var y2o = cy + Math.sin(endAngle)*outerR;
    var x1i = cx + Math.cos(endAngle)*innerR;
    var y1i = cy + Math.sin(endAngle)*innerR;
    var x2i = cx + Math.cos(startAngle)*innerR;
    var y2i = cy + Math.sin(startAngle)*innerR;

    var d = "M"+x1o+","+y1o+
      " A"+outerR+","+outerR+" 0 "+largeArc+",1 "+x2o+","+y2o+
      " L"+x1i+","+y1i+
      " A"+innerR+","+innerR+" 0 "+largeArc+",0 "+x2i+","+y2i+" Z";
    svg.appendChild(svgEl("path", {d:d, fill:s.color||COLORS.primary}));

    // Label at midpoint
    var midAngle = startAngle + frac*Math.PI;
    var labelR = (outerR + innerR)/2;
    if (frac > 0.08) {
      var lt = svgEl("text", {x:cx+Math.cos(midAngle)*labelR, y:cy+Math.sin(midAngle)*labelR+4,
        fill:"#d0d3de", "font-size":"10", "font-weight":"500", "text-anchor":"middle"});
      lt.textContent = Math.round(frac*100)+"%";
      svg.appendChild(lt);
    }

    startAngle = endAngle;
  });

  // Center label
  if (opts.centerLabel) {
    var ct = svgEl("text", {x:cx, y:cy+2, fill:"#d0d3de", "font-size":"14", "font-weight":"400", "text-anchor":"middle", "dominant-baseline":"middle"});
    ct.textContent = opts.centerLabel;
    svg.appendChild(ct);
  }

  container.appendChild(svg);
}

/* =============================================
   CHART 7: STRIP PLOT
   ============================================= */
function stripPlot(container, values, opts) {
  opts = opts || {};
  var w = 500, h = opts.height || 50;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!values || values.length === 0) return;

  var pad = 30;
  var usableW = w - pad*2;
  var vals = values.filter(function(v){return v!=null});
  var mn = opts.min != null ? opts.min : Math.min.apply(null, vals);
  var mx = opts.max != null ? opts.max : Math.max.apply(null, vals);
  if (mn===mx){mn-=1;mx+=1;}
  var range = mx - mn;
  var cy = h/2;

  // Axis line
  svg.appendChild(svgEl("line", {x1:pad, y1:cy, x2:w-pad, y2:cy, stroke:"#1c1e26", "stroke-width":"2"}));

  // Mean marker
  var mean = vals.reduce(function(a,b){return a+b},0)/vals.length;
  var meanX = pad + ((mean-mn)/range)*usableW;
  svg.appendChild(svgEl("line", {x1:meanX, y1:cy-14, x2:meanX, y2:cy+14, stroke:"#c4a04e", "stroke-width":"2", opacity:"0.7"}));

  // Dots with jitter
  vals.forEach(function(v){
    var x = pad + ((v-mn)/range)*usableW;
    var jitter = (Math.random()-0.5)*16;
    svg.appendChild(svgEl("circle", {cx:x, cy:cy+jitter, r:"3.5",
      fill:opts.color||COLORS.primary, opacity:"0.6"}));
  });

  // Labels
  var lbl1 = svgEl("text", {x:pad, y:h-2, fill:"#5a6070", "font-size":"9", "text-anchor":"start"});
  lbl1.textContent = opts.minLabel || fmt(mn, 0);
  svg.appendChild(lbl1);
  var lbl2 = svgEl("text", {x:w-pad, y:h-2, fill:"#5a6070", "font-size":"9", "text-anchor":"end"});
  lbl2.textContent = opts.maxLabel || fmt(mx, 0);
  svg.appendChild(lbl2);

  container.appendChild(svg);
}

/* =============================================
   CHART 8: HEATMAP GRID
   ============================================= */
function heatmapGrid(container, data, opts) {
  opts = opts || {};
  // data: [{date, value}] OR a matrix for correlation
  if (opts.matrixMode) {
    heatmapMatrix(container, data, opts);
    return;
  }
  // Calendar-style heatmap
  var w = 600, cellSize = opts.cellSize || 14, gap = 2;
  if (!data || data.length === 0) return;

  var vals = data.map(function(d){return d.value}).filter(function(v){return v!=null});
  var mn = opts.min != null ? opts.min : Math.min.apply(null, vals);
  var mx = opts.max != null ? opts.max : Math.max.apply(null, vals);

  // Group by week
  var dateMap = {};
  data.forEach(function(d){ dateMap[d.date] = d.value; });

  // Sort dates
  var sortedDates = data.map(function(d){return d.date}).sort();
  if (sortedDates.length === 0) return;

  var startDate = new Date(sortedDates[0]+"T00:00:00");
  var endDate = new Date(sortedDates[sortedDates.length-1]+"T00:00:00");
  var startDay = startDate.getDay(); // 0=Sun

  // Count weeks
  var totalDays = Math.ceil((endDate - startDate)/(86400000)) + 1;
  var numWeeks = Math.ceil((totalDays + startDay) / 7);
  var svgW = numWeeks * (cellSize+gap) + 40;
  var svgH = 7 * (cellSize+gap) + 24;

  var svg = svgEl("svg", {viewBox:"0 0 "+svgW+" "+svgH, preserveAspectRatio:"xMinYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block"; svg.style.maxWidth = svgW+"px";

  // Day labels
  ["S","M","T","W","T","F","S"].forEach(function(d, i){
    var yt = svgEl("text", {x:12, y:20 + i*(cellSize+gap) + cellSize/2 + 3, fill:"#5a6070", "font-size":"9", "text-anchor":"middle"});
    yt.textContent = d;
    svg.appendChild(yt);
  });

  // Cells
  var cur = new Date(startDate);
  var offsetX = 30;
  for (var week=0; week<numWeeks; week++){
    for (var day=0; day<7; day++){
      if (week===0 && day<startDay) continue;
      var dateStr = cur.toISOString().slice(0,10);
      if (cur > endDate) break;
      var val = dateMap[dateStr];
      var color = val != null ? heatColor(val, mn, mx) : "#0e1014";
      var rx = offsetX + week*(cellSize+gap);
      var ry = 14 + day*(cellSize+gap);
      var rect = svgEl("rect", {x:rx, y:ry, width:cellSize, height:cellSize, rx:"3", fill:color});
      if (val != null) {
        var title = svgEl("title"); title.textContent = dateStr+": "+fmt(val,0);
        rect.appendChild(title);
      }
      svg.appendChild(rect);
      cur.setDate(cur.getDate()+1);
    }
  }

  container.appendChild(svg);
}

function heatmapMatrix(container, data, opts) {
  // data: {matrix, metric_names}
  var names = data.metric_names || [];
  var matrix = data.matrix || [];
  var n = names.length;
  if (n === 0) return;
  var cellSize = opts.cellSize || 44;
  var labelW = 120;
  var labelH = 80;
  var svgW = labelW + n*cellSize;
  var svgH = labelH + n*cellSize;
  var svg = svgEl("svg", {viewBox:"0 0 "+svgW+" "+svgH, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";

  // Build lookup
  var valMap = {};
  matrix.forEach(function(row){
    valMap[row.metric] = row.values;
  });

  // Column headers (rotated)
  names.forEach(function(name, ci){
    var tx = labelW + ci*cellSize + cellSize/2;
    var ty = labelH - 6;
    var t = svgEl("text", {x:tx, y:ty, fill:"#7b8090", "font-size":"9",
      "text-anchor":"start", transform:"rotate(-45 "+tx+" "+ty+")"});
    t.textContent = name.replace(/-/g," ").slice(0,14);
    svg.appendChild(t);
  });

  // Rows
  names.forEach(function(rowName, ri){
    // Row label
    var rl = svgEl("text", {x:labelW-6, y:labelH + ri*cellSize + cellSize/2 + 3,
      fill:"#7b8090", "font-size":"9", "text-anchor":"end"});
    rl.textContent = rowName.replace(/-/g," ").slice(0,14);
    svg.appendChild(rl);

    var rowVals = valMap[rowName] || {};
    names.forEach(function(colName, ci){
      var v = rowVals[colName];
      var cx = labelW + ci*cellSize;
      var cy = labelH + ri*cellSize;
      var color = v != null ? corrColor(v) : "#0e1014";
      svg.appendChild(svgEl("rect", {x:cx+1, y:cy+1, width:cellSize-2, height:cellSize-2, rx:"4", fill:color}));
      if (v != null && ri !== ci) {
        var vt = svgEl("text", {x:cx+cellSize/2, y:cy+cellSize/2+3, fill:"#a0a4b0", "font-size":"8",
          "font-weight":"500", "text-anchor":"middle"});
        vt.textContent = v.toFixed(2);
        svg.appendChild(vt);
      }
    });
  });

  container.appendChild(svg);
}

/* =============================================
   CHART 9: HISTOGRAM
   ============================================= */
function histogram(container, bins, opts) {
  opts = opts || {};
  var w = 400, h = opts.height || 120;
  var pad = {top:10, right:10, bottom:24, left:36};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!bins || bins.length === 0) return;

  var maxCount = Math.max.apply(null, bins.map(function(b){return b.count||0})) || 1;
  var barW = cw / bins.length - 2;

  bins.forEach(function(b, i){
    var bh = ((b.count||0)/maxCount)*ch;
    var x = pad.left + i*(cw/bins.length) + 1;
    var y = pad.top + ch - bh;
    svg.appendChild(svgEl("rect", {x:x, y:y, width:Math.max(2,barW), height:Math.max(0,bh),
      rx:"2", fill:opts.color||COLORS.primary, opacity:"0.8"}));
    // Label
    var lt = svgEl("text", {x:x+barW/2, y:h-6, fill:"#5a6070", "font-size":"8", "text-anchor":"middle"});
    lt.textContent = fmt(b.from,opts.labelDecimals!=null?opts.labelDecimals:0);
    svg.appendChild(lt);
    // Count on top
    if (b.count > 0) {
      var ct = svgEl("text", {x:x+barW/2, y:y-4, fill:"#7b8090", "font-size":"8", "text-anchor":"middle"});
      ct.textContent = b.count;
      svg.appendChild(ct);
    }
  });

  container.appendChild(svg);
}

/* =============================================
   CHART 10: HORIZON CHART
   ============================================= */
function horizonChart(container, values, opts) {
  opts = opts || {};
  var w = 600, h = opts.height || 60;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!values || values.length === 0) return;

  var pad = {left:4, right:4, top:4, bottom:4};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var vals = values.filter(function(v){return v!=null});
  if (vals.length === 0) return;
  var mean = vals.reduce(function(a,b){return a+b},0)/vals.length;
  var maxDev = Math.max.apply(null, vals.map(function(v){return Math.abs(v-mean);})) || 1;
  var bands = opts.bands || 3;
  var bandH = ch / bands;
  var baseColors = opts.upColor ? [opts.upColor] : ['#5b6abf','#7c83db','#9b8ec4'];
  var downColors = opts.downColor ? [opts.downColor] : ['#b36b6b','#c48888','#d4a8a8'];

  // Draw baseline
  svg.appendChild(svgEl("line", {x1:pad.left, y1:pad.top+ch, x2:w-pad.right, y2:pad.top+ch,
    stroke:"#1c1e26", "stroke-width":"1"}));

  // For each band layer
  for (var band = 0; band < bands; band++) {
    var pts = [];
    for (var i=0;i<values.length;i++){
      if (values[i]==null) continue;
      var dev = values[i] - mean;
      var norm = dev / maxDev; // -1 to 1
      var absNorm = Math.abs(norm) * bands;
      var bandVal = clamp(absNorm - band, 0, 1);
      var x = pad.left + (i/(values.length-1))*cw;
      var bh = bandVal * bandH;
      if (dev >= 0) {
        pts.push({x:x, y:pad.top + ch - bh, above:true, bh:bh});
      } else {
        pts.push({x:x, y:pad.top + ch - bh, above:false, bh:bh});
      }
    }
    // Draw above
    if (pts.length > 1) {
      var areaAbove = "M"+pts[0].x+","+(pad.top+ch);
      pts.forEach(function(p){ areaAbove += " L"+p.x.toFixed(1)+","+(p.above ? p.y.toFixed(1) : (pad.top+ch)); });
      areaAbove += " L"+pts[pts.length-1].x+","+(pad.top+ch)+" Z";
      svg.appendChild(svgEl("path", {d:areaAbove, fill:baseColors[band%baseColors.length]||COLORS.primary,
        opacity:String(0.4 + band*0.2)}));
    }
  }

  container.appendChild(svg);
}

/* =============================================
   CHART 11: BOX PLOT
   ============================================= */
function boxPlot(container, boxes, opts) {
  opts = opts || {};
  var w = 500, h = opts.height || 140;
  var pad = {top:20, right:20, bottom:30, left:50};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!boxes || boxes.length === 0) return;

  var allVals = [];
  boxes.forEach(function(b){ allVals.push(b.min, b.max); });
  var mn = opts.yMin != null ? opts.yMin : Math.min.apply(null, allVals);
  var mx = opts.yMax != null ? opts.yMax : Math.max.apply(null, allVals);
  if (mn===mx){mn-=1;mx+=1;}
  var range = mx - mn;

  function yPos(v){ return pad.top + ch - ((v-mn)/range)*ch; }
  var boxW = Math.min(40, cw/boxes.length*0.6);

  // Y gridlines
  for (var g=0;g<=4;g++){
    var gy = pad.top + (g/4)*ch;
    var gv = mx - (g/4)*range;
    svg.appendChild(svgEl("line", {x1:pad.left, y1:gy, x2:w-pad.right, y2:gy, stroke:"#1c1e26", "stroke-width":"1"}));
    var yt = svgEl("text", {x:pad.left-6, y:gy+3, fill:"#5a6070", "font-size":"9", "text-anchor":"end"});
    yt.textContent = fmt(gv,0);
    svg.appendChild(yt);
  }

  boxes.forEach(function(b, i){
    var cx = pad.left + (i+0.5)*(cw/boxes.length);
    var yMin = yPos(b.min);
    var yMax = yPos(b.max);
    var yQ1 = yPos(b.q1);
    var yQ3 = yPos(b.q3);
    var yMed = yPos(b.median);

    // Whisker
    svg.appendChild(svgEl("line", {x1:cx, y1:yMin, x2:cx, y2:yQ1, stroke:"#5a6070", "stroke-width":"1"}));
    svg.appendChild(svgEl("line", {x1:cx, y1:yQ3, x2:cx, y2:yMax, stroke:"#5a6070", "stroke-width":"1"}));
    // Caps
    svg.appendChild(svgEl("line", {x1:cx-boxW/4, y1:yMin, x2:cx+boxW/4, y2:yMin, stroke:"#5a6070", "stroke-width":"1"}));
    svg.appendChild(svgEl("line", {x1:cx-boxW/4, y1:yMax, x2:cx+boxW/4, y2:yMax, stroke:"#5a6070", "stroke-width":"1"}));
    // Box
    svg.appendChild(svgEl("rect", {x:cx-boxW/2, y:yQ3, width:boxW, height:Math.max(1,yQ1-yQ3),
      rx:"3", fill:opts.color||COLORS.primary, opacity:"0.5", stroke:opts.color||COLORS.primary, "stroke-width":"1"}));
    // Median
    svg.appendChild(svgEl("line", {x1:cx-boxW/2, y1:yMed, x2:cx+boxW/2, y2:yMed,
      stroke:"#d0d3de", "stroke-width":"2"}));
    // Label
    var lt = svgEl("text", {x:cx, y:h-8, fill:"#7b8090", "font-size":"9", "text-anchor":"middle"});
    lt.textContent = b.label || "";
    svg.appendChild(lt);
  });

  container.appendChild(svg);
}

/* =============================================
   CHART 12: SCATTER PLOT
   ============================================= */
function scatterPlot(container, points, opts) {
  opts = opts || {};
  var w = 400, h = opts.height || 250;
  var pad = {top:16, right:16, bottom:32, left:44};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!points || points.length === 0) return;

  var xs = points.map(function(p){return p.x});
  var ys = points.map(function(p){return p.y});
  var xMn = opts.xMin != null ? opts.xMin : Math.min.apply(null, xs);
  var xMx = opts.xMax != null ? opts.xMax : Math.max.apply(null, xs);
  var yMn = opts.yMin != null ? opts.yMin : Math.min.apply(null, ys);
  var yMx = opts.yMax != null ? opts.yMax : Math.max.apply(null, ys);
  if (xMn===xMx){xMn-=1;xMx+=1;}
  if (yMn===yMx){yMn-=1;yMx+=1;}

  function xPos(v){ return pad.left + ((v-xMn)/(xMx-xMn))*cw; }
  function yPos(v){ return pad.top + ch - ((v-yMn)/(yMx-yMn))*ch; }

  // Grid
  for (var g=0;g<=4;g++){
    var gy = pad.top + (g/4)*ch;
    svg.appendChild(svgEl("line", {x1:pad.left, y1:gy, x2:w-pad.right, y2:gy, stroke:"#1c1e26", "stroke-width":"1"}));
    var yt = svgEl("text", {x:pad.left-6, y:gy+3, fill:"#5a6070", "font-size":"8", "text-anchor":"end"});
    yt.textContent = fmt(yMx - (g/4)*(yMx-yMn), 0);
    svg.appendChild(yt);
  }
  for (var g=0;g<=4;g++){
    var gx = pad.left + (g/4)*cw;
    var xt = svgEl("text", {x:gx, y:h-6, fill:"#5a6070", "font-size":"8", "text-anchor":"middle"});
    xt.textContent = fmt(xMn + (g/4)*(xMx-xMn), 0);
    svg.appendChild(xt);
  }

  // Axis labels
  if (opts.xLabel) {
    var xl = svgEl("text", {x:pad.left+cw/2, y:h-1, fill:"#6b7080", "font-size":"9", "text-anchor":"middle"});
    xl.textContent = opts.xLabel;
    svg.appendChild(xl);
  }
  if (opts.yLabel) {
    var yl = svgEl("text", {x:10, y:pad.top+ch/2, fill:"#6b7080", "font-size":"9", "text-anchor":"middle",
      transform:"rotate(-90 10 "+(pad.top+ch/2)+")"});
    yl.textContent = opts.yLabel;
    svg.appendChild(yl);
  }

  // Trend line (simple linear regression)
  if (opts.trendLine && points.length > 2) {
    var n = points.length;
    var sumX=0, sumY=0, sumXY=0, sumXX=0;
    points.forEach(function(p){ sumX+=p.x; sumY+=p.y; sumXY+=p.x*p.y; sumXX+=p.x*p.x; });
    var slope = (n*sumXY - sumX*sumY)/(n*sumXX - sumX*sumX);
    var intercept = (sumY - slope*sumX)/n;
    var tlY1 = slope*xMn + intercept;
    var tlY2 = slope*xMx + intercept;
    svg.appendChild(svgEl("line", {x1:xPos(xMn), y1:yPos(tlY1), x2:xPos(xMx), y2:yPos(tlY2),
      stroke:"#c4a04e", "stroke-width":"1.5", "stroke-dasharray":"6,4", opacity:"0.6"}));
  }

  // Points
  points.forEach(function(p){
    var c = svgEl("circle", {cx:xPos(p.x), cy:yPos(p.y), r:opts.radius||"4",
      fill:opts.color||COLORS.primary, opacity:"0.7"});
    if (p.label) {
      var title = svgEl("title"); title.textContent = p.label;
      c.appendChild(title);
    }
    svg.appendChild(c);
  });

  container.appendChild(svg);
}

/* =============================================
   CHART 13: LOLLIPOP CHART
   ============================================= */
function lollipopChart(container, data, opts) {
  opts = opts || {};
  var w = 500, h = opts.height || 140;
  var pad = {top:10, right:10, bottom:24, left:4};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!data || !data.values || data.values.length === 0) return;

  var values = data.values;
  var dates = data.dates || [];
  var vals = values.filter(function(v){return v!=null && v>0});
  if (vals.length === 0) return;
  var mx = opts.yMax || Math.max.apply(null, vals);

  var baseY = pad.top + ch;

  values.forEach(function(v, i){
    var x = pad.left + (i+0.5)*(cw/values.length);
    if (v != null && v > 0) {
      var bh = (v/mx)*ch;
      var topY = baseY - bh;
      // Stick
      svg.appendChild(svgEl("line", {x1:x, y1:baseY, x2:x, y2:topY,
        stroke:opts.color||COLORS.info, "stroke-width":"2", opacity:"0.6"}));
      // Dot
      svg.appendChild(svgEl("circle", {cx:x, cy:topY, r:"4",
        fill:opts.color||COLORS.info}));
    }
  });

  // X labels
  if (dates.length > 0) {
    var step = Math.max(1, Math.floor(dates.length/8));
    for (var i=0;i<dates.length;i+=step){
      var xt = svgEl("text", {x:pad.left+(i+0.5)*(cw/values.length), y:h-4, fill:"#5a6070", "font-size":"8", "text-anchor":"middle"});
      xt.textContent = (dates[i]||"").slice(5);
      svg.appendChild(xt);
    }
  }

  // Baseline
  svg.appendChild(svgEl("line", {x1:pad.left, y1:baseY, x2:w-pad.right, y2:baseY, stroke:"#1c1e26", "stroke-width":"1"}));

  container.appendChild(svg);
}

/* =============================================
   CHART 14: GAUGE CHART
   ============================================= */
function gaugeChart(container, value, opts) {
  opts = opts || {};
  var size = opts.size || 160;
  var cx = size/2, cy = size/2 + 10;
  var R = size/2 - 20;
  var svg = svgEl("svg", {viewBox:"0 0 "+size+" "+(size*0.7), width:size, height:size*0.7});
  svg.style.display = "block";
  svg.style.margin = "0 auto";

  var startAngle = Math.PI;
  var endAngle = 2*Math.PI;
  var v = clamp(value/100, 0, 1);
  var valAngle = startAngle + v*(endAngle-startAngle);

  // Background arc
  var bgPath = describeArc(cx, cy, R, startAngle, endAngle);
  svg.appendChild(svgEl("path", {d:bgPath, fill:"none", stroke:"#1c1e26", "stroke-width":"12", "stroke-linecap":"round"}));

  // Value arc
  if (v > 0.01) {
    var valPath = describeArc(cx, cy, R, startAngle, valAngle);
    var color = v >= 0.7 ? COLORS.success : v >= 0.4 ? COLORS.warning : COLORS.danger;
    svg.appendChild(svgEl("path", {d:valPath, fill:"none", stroke:opts.color||color, "stroke-width":"12", "stroke-linecap":"round"}));
  }

  // Value text
  var vt = svgEl("text", {x:cx, y:cy-6, fill:"#d0d3de", "font-size":"20", "font-weight":"300", "text-anchor":"middle"});
  vt.textContent = Math.round(value)+"%";
  svg.appendChild(vt);

  // Label
  if (opts.label) {
    var lt = svgEl("text", {x:cx, y:cy+12, fill:"#6b7080", "font-size":"10", "text-anchor":"middle"});
    lt.textContent = opts.label;
    svg.appendChild(lt);
  }

  container.appendChild(svg);
}

function describeArc(cx, cy, r, startAngle, endAngle) {
  var x1 = cx + r * Math.cos(startAngle);
  var y1 = cy + r * Math.sin(startAngle);
  var x2 = cx + r * Math.cos(endAngle);
  var y2 = cy + r * Math.sin(endAngle);
  var largeArc = (endAngle - startAngle) > Math.PI ? 1 : 0;
  return "M"+x1+","+y1+" A"+r+","+r+" 0 "+largeArc+",1 "+x2+","+y2;
}

/* =============================================
   CHART 15: GROUPED BAR
   ============================================= */
function groupedBar(container, categories, series, opts) {
  opts = opts || {};
  var w = 500, h = opts.height || 160;
  var pad = {top:10, right:10, bottom:30, left:40};
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var svg = svgEl("svg", {viewBox:"0 0 "+w+" "+h, preserveAspectRatio:"xMidYMid meet"});
  svg.style.width = "100%"; svg.style.display = "block";
  if (!categories || categories.length===0 || !series || series.length===0) return;

  var allVals = [];
  series.forEach(function(s){ s.values.forEach(function(v){ if(v!=null) allVals.push(v); }); });
  var mx = opts.yMax || Math.max.apply(null, allVals) || 1;

  var groupW = cw / categories.length;
  var barW = Math.min(20, (groupW - 8) / series.length);
  var baseY = pad.top + ch;

  // Y gridlines
  for (var g=0;g<=4;g++){
    var gy = pad.top + (g/4)*ch;
    svg.appendChild(svgEl("line", {x1:pad.left, y1:gy, x2:w-pad.right, y2:gy, stroke:"#1c1e26", "stroke-width":"1"}));
    var yt = svgEl("text", {x:pad.left-6, y:gy+3, fill:"#5a6070", "font-size":"8", "text-anchor":"end"});
    yt.textContent = fmt(mx - (g/4)*mx, 0);
    svg.appendChild(yt);
  }

  categories.forEach(function(cat, ci){
    var groupX = pad.left + ci*groupW + groupW/2;
    var totalBarW = series.length * barW;
    var startX = groupX - totalBarW/2;

    series.forEach(function(s, si){
      var val = s.values[ci] || 0;
      var bh = (val/mx)*ch;
      var bx = startX + si*barW;
      svg.appendChild(svgEl("rect", {x:bx, y:baseY-bh, width:barW-1, height:Math.max(0,bh),
        rx:"2", fill:s.color||COLORS.primary}));
    });

    // Category label
    var lt = svgEl("text", {x:groupX, y:h-6, fill:"#7b8090", "font-size":"9", "text-anchor":"middle"});
    lt.textContent = cat;
    svg.appendChild(lt);
  });

  container.appendChild(svg);
}

/* =============================================
   REUSABLE: STATS PANEL
   ============================================= */
function statsPanel(container, stats, opts) {
  opts = opts || {};
  if (!stats) return;
  var wrap = el("div");

  // Hero row
  var heroRow = el("div", {className:"stats-row"});
  if (stats.mean != null) {
    var mi = el("div", {className:"stat-item"});
    mi.appendChild(el("div", {className:"stat-label", textContent:"MEAN"}));
    mi.appendChild(el("div", {className:"stat-value", textContent:fmt(stats.mean, opts.decimals)}));
    heroRow.appendChild(mi);
  }
  if (stats.median != null) {
    var mi = el("div", {className:"stat-item"});
    mi.appendChild(el("div", {className:"stat-label", textContent:"MEDIAN"}));
    mi.appendChild(el("div", {className:"stat-value", textContent:fmt(stats.median, opts.decimals)}));
    heroRow.appendChild(mi);
  }
  if (stats.stdev != null) {
    var mi = el("div", {className:"stat-item"});
    mi.appendChild(el("div", {className:"stat-label", textContent:"STD DEV"}));
    mi.appendChild(el("div", {className:"stat-value", textContent:fmt(stats.stdev, opts.decimals!=null?opts.decimals:2)}));
    heroRow.appendChild(mi);
  }
  if (stats.n != null) {
    var mi = el("div", {className:"stat-item"});
    mi.appendChild(el("div", {className:"stat-label", textContent:"SAMPLES"}));
    mi.appendChild(el("div", {className:"stat-value", textContent:stats.n}));
    heroRow.appendChild(mi);
  }
  wrap.appendChild(heroRow);

  // Percentile bar
  var pctls = stats.percentiles;
  if (pctls && stats.min && stats.max) {
    var pBar = el("div", {style:{margin:"12px 0"}});
    var bar = el("div", {className:"pctl-bar"});
    var mn = stats.min.value != null ? stats.min.value : 0;
    var mx = stats.max.value != null ? stats.max.value : 100;
    var range = mx - mn || 1;

    // IQR fill
    if (pctls.p25 != null && pctls.p75 != null) {
      var left = ((pctls.p25-mn)/range)*100;
      var width = ((pctls.p75-pctls.p25)/range)*100;
      var fill = el("div", {className:"pctl-fill", style:{position:"absolute",left:left+"%",width:width+"%"}});
      bar.appendChild(fill);
    }
    // Median marker
    if (stats.median != null) {
      var medPos = ((stats.median-mn)/range)*100;
      var marker = el("div", {className:"pctl-marker", style:{left:medPos+"%"}});
      bar.appendChild(marker);
    }
    pBar.appendChild(bar);

    // Labels
    var labels = el("div", {className:"pctl-labels"});
    labels.appendChild(el("span", {textContent:"P10: "+fmt(pctls.p10,opts.decimals)}));
    labels.appendChild(el("span", {textContent:"P25: "+fmt(pctls.p25,opts.decimals)}));
    labels.appendChild(el("span", {textContent:"P75: "+fmt(pctls.p75,opts.decimals)}));
    labels.appendChild(el("span", {textContent:"P90: "+fmt(pctls.p90,opts.decimals)}));
    pBar.appendChild(labels);
    wrap.appendChild(pBar);
  }

  // Min/Max
  if (stats.min || stats.max) {
    var mmRow = el("div", {className:"stats-row"});
    if (stats.min) {
      var mi = el("div", {className:"stat-item"});
      mi.appendChild(el("div", {className:"stat-label", textContent:"MIN"}));
      mi.appendChild(el("div", {className:"stat-value", style:{color:COLORS.danger}, textContent:fmt(stats.min.value, opts.decimals)}));
      if (stats.min.date) mi.appendChild(el("div", {style:{fontSize:".7rem",color:"#5a6070"}, textContent:stats.min.date}));
      mmRow.appendChild(mi);
    }
    if (stats.max) {
      var mi = el("div", {className:"stat-item"});
      mi.appendChild(el("div", {className:"stat-label", textContent:"MAX"}));
      mi.appendChild(el("div", {className:"stat-value", style:{color:COLORS.success}, textContent:fmt(stats.max.value, opts.decimals)}));
      if (stats.max.date) mi.appendChild(el("div", {style:{fontSize:".7rem",color:"#5a6070"}, textContent:stats.max.date}));
      mmRow.appendChild(mi);
    }
    mmRow.appendChild(el("div",{className:"stat-item"})); // spacer
    mmRow.appendChild(el("div",{className:"stat-item"})); // spacer
    wrap.appendChild(mmRow);
  }

  // CV interpretation
  if (stats.cv != null) {
    var cvLabel = stats.cv < 0.1 ? "Very consistent" : stats.cv < 0.2 ? "Consistent" : stats.cv < 0.3 ? "Moderate variability" : "High variability";
    var cvColor = stats.cv < 0.15 ? COLORS.success : stats.cv < 0.25 ? COLORS.warning : COLORS.danger;
    var cvRow = el("div", {style:{fontSize:".82rem",margin:"6px 0",color:cvColor}});
    cvRow.textContent = "CV: "+fmt(stats.cv*100,1)+"% \u2014 "+cvLabel;
    wrap.appendChild(cvRow);
  }

  // Trend direction
  if (stats.trend_direction) {
    var tdRow = el("div", {style:{fontSize:".82rem",margin:"4px 0"}});
    var arrow = trendArrow(stats.trend_direction);
    tdRow.appendChild(el("span", {textContent:arrow+" Trend: "+stats.trend_direction}));
    if (stats.period_comparison) {
      var pc = stats.period_comparison;
      var sign = pc.change_pct > 0 ? "+" : "";
      tdRow.appendChild(el("span", {style:{color:"#6b7080",marginLeft:"12px"},
        textContent:"(1st half "+fmt(pc.first_half_avg,opts.decimals)+" \u2192 2nd half "+fmt(pc.second_half_avg,opts.decimals)+", "+sign+fmt(pc.change_pct,1)+"%)" }));
    }
    wrap.appendChild(tdRow);
  }

  container.appendChild(wrap);
}

/* =============================================
   REUSABLE: KNOWLEDGE PANEL
   ============================================= */
var KNOWLEDGE = {
  sleep: {
    title: "Understanding Your Sleep",
    text: "<strong>Deep sleep</strong> is critical for physical recovery, immune function, and memory consolidation. Adults typically spend 15-20% of sleep in deep stages. "+
      "<strong>REM sleep</strong> supports emotional processing and creativity, usually comprising 20-25% of total sleep. "+
      "<strong>Bedtime consistency</strong> (low stdev) is linked to better cardiovascular health and mood stability. "+
      "A CV below 10% indicates excellent sleep regularity."
  },
  heart: {
    title: "Heart Health Indicators",
    text: "<strong>Resting heart rate</strong> (RHR) reflects cardiovascular fitness; lower is generally better for adults (50-70 bpm is typical). "+
      "<strong>Heart rate variability</strong> (HRV) measures the variation between heartbeats and indicates autonomic nervous system balance. "+
      "Higher HRV generally suggests better recovery capacity and stress resilience. "+
      "An inverse relationship between RHR and HRV is normal and healthy."
  },
  activity: {
    title: "Activity & Movement",
    text: "The WHO recommends <strong>150-300 minutes</strong> of moderate exercise per week. "+
      "<strong>Step count</strong> of 7,000-10,000 daily is associated with reduced mortality risk. "+
      "Consistency matters more than peak days \u2014 a low coefficient of variation (CV) in daily steps suggests sustainable habits. "+
      "<strong>Active energy</strong> burned varies widely by body composition and activity type."
  },
  respiratory: {
    title: "Respiratory Health",
    text: "Normal adult <strong>respiratory rate</strong> at rest is 12-20 breaths per minute. "+
      "<strong>Blood oxygen (SpO2)</strong> should typically stay above 95%. "+
      "Persistent readings below 94% may warrant medical attention. "+
      "Slight variations during sleep are normal, but large dips may indicate sleep-disordered breathing."
  },
  mobility: {
    title: "Mobility & Gait",
    text: "<strong>Walking speed</strong> is considered a vital sign for overall health, especially in aging. "+
      "Typical adult walking speed is 1.2-1.4 m/s. "+
      "<strong>Step length asymmetry</strong> below 5% is considered normal; higher values may indicate musculoskeletal issues. "+
      "Consistent gait metrics suggest good neuromuscular coordination."
  },
  interconnections: {
    title: "How Your Metrics Connect",
    text: "Correlations show how metrics move together over time. "+
      "An <strong>r value</strong> near +1 means metrics rise and fall together; near -1 means they move in opposite directions. "+
      "Only correlations with p < 0.05 and |r| > 0.3 are considered meaningful. "+
      "Correlation does not imply causation \u2014 a third factor may drive both metrics."
  },
  vitals: {
    title: "Blood Pressure",
    text: "<strong>Blood pressure</strong> is recorded as systolic over diastolic (e.g. 120/80 mmHg). "+
      "The American Heart Association classifies readings as: <strong>Normal</strong> (<120/<80), "+
      "<strong>Elevated</strong> (120\u2013129/<80), <strong>Stage 1 Hypertension</strong> (130\u2013139 or 80\u201389), "+
      "and <strong>Stage 2 Hypertension</strong> (140+ or 90+). "+
      "Blood pressure varies throughout the day and can be influenced by stress, caffeine, posture, and activity. "+
      "Apple Watch blood pressure sensing is an emerging feature with limited clinical validation \u2014 "+
      "use it for trend awareness, not diagnosis. A cuff-based measurement remains the clinical standard."
  },
  body: {
    title: "Body Composition",
    text: "<strong>Body mass</strong> fluctuates naturally by 1\u20132 kg day-to-day due to hydration, meals, and sodium intake. "+
      "Weekly averages are more meaningful than any single reading. "+
      "<strong>BMI</strong> (Body Mass Index) is a rough population-level screening tool; it does not distinguish muscle from fat "+
      "and can misclassify athletic individuals. "+
      "<strong>Body fat percentage</strong> is a more useful indicator of metabolic health. Healthy ranges vary by age and sex "+
      "(roughly 10\u201320% for men, 18\u201328% for women). "+
      "<strong>Lean body mass</strong> includes muscle, bone, organs, and water \u2014 maintaining it is important for metabolism, "+
      "mobility, and long-term health."
  }
};

function knowledgePanel(container, sectionKey) {
  var info = KNOWLEDGE[sectionKey];
  if (!info) return;
  var kp = el("div", {className:"knowledge-panel"});
  kp.appendChild(el("div", {className:"kp-title", textContent:info.title}));
  kp.appendChild(el("div", {innerHTML:info.text}));
  container.appendChild(kp);
}

/* =============================================
   SECTION RENDERERS
   ============================================= */

/* --- HEADER --- */
function renderHeader(D) {
  var sec = section("header");
  var period = D.period || {};
  var meth = D.methodology || {};
  sec.style.textAlign = "center";
  sec.style.paddingBottom = "32px";

  sec.appendChild(el("div", {style:{fontSize:".75rem",letterSpacing:"1.5px",color:"#6b7080",marginBottom:"8px"},
    textContent:"Premium Health Assessment"}));
  sec.appendChild(el("h1", {style:{fontSize:"2.6rem",fontWeight:"300",marginBottom:"10px"}, textContent:"Health Report"}));
  sec.appendChild(el("div", {style:{color:"#6b7080",fontSize:".95rem"},
    textContent:(period.from||"?")+"  to  "+(period.to||"?")}));
  if (meth.generated_at) {
    sec.appendChild(el("div", {style:{color:"#5a6070",fontSize:".78rem",marginTop:"8px"},
      textContent:"Generated "+meth.generated_at}));
  }
}

/* --- EXECUTIVE SUMMARY --- */
function renderExecutiveSummary(D) {
  var es = D.executive_summary;
  if (!es || !es.categories || es.categories.length === 0) return;

  var sec = section("executive-summary");
  sectionHeader(sec, "Executive Summary", "Overall health snapshot across all categories");

  // Radar chart
  var radarCard = card(null, [], "wide");
  var radarWrap = el("div", {style:{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"center",gap:"32px"}});

  var radarDiv = el("div");
  var axes = es.categories.map(function(c){ return {label:c.name, value:c.score}; });
  radarChart(radarDiv, axes, {size:280, maxVal:5});
  radarWrap.appendChild(radarDiv);

  // Score tiles
  var tilesDiv = el("div", {style:{flex:"1",minWidth:"280px"}});
  es.categories.forEach(function(c){
    var tile = el("div", {style:{display:"flex",alignItems:"center",gap:"16px",padding:"10px 0",borderBottom:"1px solid #1c1e26"}});

    // Score badge
    var scoreColor = c.score >= 4 ? COLORS.success : c.score >= 3 ? COLORS.warning : COLORS.danger;
    var badge = el("div", {style:{width:"42px",height:"42px",borderRadius:"10px",background:"rgba("+
      (c.score>=4?"107,163,122":c.score>=3?"196,160,78":"179,107,107")+",0.1)",
      display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.1rem",fontWeight:"400",color:scoreColor},
      textContent:fmt(c.score,1)});
    tile.appendChild(badge);

    var info = el("div", {style:{flex:"1"}});
    var nameRow = el("div", {style:{display:"flex",alignItems:"center",gap:"8px"}});
    nameRow.appendChild(el("span", {style:{fontWeight:"500",color:"#a0a4b0"}, textContent:c.name}));
    if (c.trend) {
      var tDir = c.trend === "up" || c.trend === "improving" ? "up" : c.trend === "down" || c.trend === "declining" ? "down" : "flat";
      nameRow.appendChild(el("span", {className:"trend "+tDir, textContent:trendArrow(c.trend)+" "+c.trend}));
    }
    info.appendChild(nameRow);

    var valRow = el("div", {style:{display:"flex",alignItems:"center",gap:"12px",marginTop:"4px"}});
    if (c.summary_value != null) {
      valRow.appendChild(el("span", {style:{fontSize:".85rem",color:"#7b8090"},
        textContent:fmt(c.summary_value,1)+" "+(c.unit||"")}));
    }
    // Sparkline
    if (c.sparkline && c.sparkline.length > 2) {
      var spk = el("span");
      sparkline(spk, c.sparkline, {width:80, height:24, color:scoreColor});
      valRow.appendChild(spk);
    }
    info.appendChild(valRow);
    tile.appendChild(info);
    tilesDiv.appendChild(tile);
  });
  radarWrap.appendChild(tilesDiv);
  radarCard.appendChild(radarWrap);
  sec.appendChild(radarCard);

  // Bullet charts row
  var bulletCard = card("Category Scores", [], "wide");
  es.categories.forEach(function(c){
    bulletChart(bulletCard, {value:c.score, min:0, max:5, previous:null}, {label:c.name, color:
      c.score>=4?COLORS.success:c.score>=3?COLORS.warning:COLORS.danger, decimals:1});
  });
  sec.appendChild(bulletCard);
}

/* --- VITALS (Blood Pressure) --- */
function renderVitals(D) {
  var v = D.vitals;
  if (!v) return;
  var sec = section("vitals");
  sectionHeader(sec, "Vitals", "Blood pressure readings and trends");

  var sysS = v.systolic_stats || {};
  var diaS = v.diastolic_stats || {};

  // Hero cards
  var grid = el("div", {className:"grid"});

  var sysCard = card("Systolic");
  var sysClass = sysS.mean < 120 ? "normal" : sysS.mean < 130 ? "elevated" : sysS.mean < 140 ? "stage 1" : "stage 2";
  var sysTrend = sysS.mean < 120 ? "up" : sysS.mean < 130 ? "flat" : "warn";
  sysCard.appendChild(bigNum(fmt(sysS.mean, 0), "mmHg", sysTrend, sysClass));
  statsPanel(sysCard, sysS, {decimals: 0});
  grid.appendChild(sysCard);

  var diaCard = card("Diastolic");
  var diaClass = diaS.mean < 80 ? "normal" : diaS.mean < 90 ? "stage 1" : "stage 2";
  var diaTrend = diaS.mean < 80 ? "up" : diaS.mean < 90 ? "flat" : "warn";
  diaCard.appendChild(bigNum(fmt(diaS.mean, 0), "mmHg", diaTrend, diaClass));
  statsPanel(diaCard, diaS, {decimals: 0});
  grid.appendChild(diaCard);

  sec.appendChild(grid);

  // Blood pressure scatter plot (systolic vs diastolic)
  var paired = v.paired_readings || [];
  if (paired.length > 2) {
    var scatCard = card("Systolic vs Diastolic", [], "wide");
    var pts = paired.map(function(r) {
      return {x: r.diastolic, y: r.systolic, label: r.date + ": " + r.systolic + "/" + r.diastolic};
    });
    scatterPlot(scatCard, pts, {
      color: COLORS.danger, trendLine: true,
      xLabel: "Diastolic (mmHg)", yLabel: "Systolic (mmHg)", height: 260
    });
    sec.appendChild(scatCard);
  }

  // Systolic area trend
  if (sysS.dates && sysS.values) {
    var sysArea = card("Systolic Trend", [], "wide");
    areaChart(sysArea, {dates: sysS.dates, values: sysS.values, rolling_7d: sysS.rolling_7d},
      {color: COLORS.danger, height: 140});
    sysArea.appendChild(legendRow([
      {color: COLORS.danger, label: "Systolic"},
      {color: "#c4a04e", label: "7-day rolling avg"}
    ]));
    sec.appendChild(sysArea);
  }

  // Diastolic area trend
  if (diaS.dates && diaS.values) {
    var diaArea = card("Diastolic Trend", [], "wide");
    areaChart(diaArea, {dates: diaS.dates, values: diaS.values, rolling_7d: diaS.rolling_7d},
      {color: COLORS.info, height: 140});
    diaArea.appendChild(legendRow([
      {color: COLORS.info, label: "Diastolic"},
      {color: "#c4a04e", label: "7-day rolling avg"}
    ]));
    sec.appendChild(diaArea);
  }

  knowledgePanel(sec, "vitals");
}

/* --- BODY COMPOSITION --- */
function renderBody(D) {
  var b = D.body;
  if (!b) return;
  var sec = section("body");
  sectionHeader(sec, "Body Composition", "Mass, body fat, and lean tissue");

  var massS = b.mass_stats || {};
  var bfS = b.body_fat_stats;
  var bmiS = b.bmi_stats;
  var lmS = b.lean_mass_stats;

  // Hero cards
  var grid = el("div", {className:"grid"});

  var massCard = card("Body Mass");
  massCard.appendChild(bigNum(fmt(massS.mean, 1), "kg",
    massS.trend_direction === "up" ? "warn" : massS.trend_direction === "down" ? "down" : "flat",
    massS.trend_direction || "stable"));
  statsPanel(massCard, massS, {decimals: 1});
  grid.appendChild(massCard);

  if (bmiS) {
    var bmiCard = card("BMI");
    var bmiLabel = bmiS.mean < 18.5 ? "underweight" : bmiS.mean < 25 ? "normal" : bmiS.mean < 30 ? "overweight" : "obese";
    var bmiTrend = bmiS.mean < 18.5 ? "warn" : bmiS.mean < 25 ? "up" : bmiS.mean < 30 ? "flat" : "down";
    bmiCard.appendChild(bigNum(fmt(bmiS.mean, 1), "", bmiTrend, bmiLabel));
    statsPanel(bmiCard, bmiS, {decimals: 1});
    grid.appendChild(bmiCard);
  }

  if (bfS) {
    var bfCard = card("Body Fat");
    bfCard.appendChild(bigNum(fmt(bfS.mean, 1), "%"));
    statsPanel(bfCard, bfS, {decimals: 1});
    grid.appendChild(bfCard);
  }

  if (lmS) {
    var lmCard = card("Lean Body Mass");
    lmCard.appendChild(bigNum(fmt(lmS.mean, 1), "kg"));
    statsPanel(lmCard, lmS, {decimals: 1});
    grid.appendChild(lmCard);
  }

  sec.appendChild(grid);

  // Body mass area chart
  if (massS.dates && massS.values) {
    var massArea = card("Body Mass Trend", [], "wide");
    areaChart(massArea, {dates: massS.dates, values: massS.values, rolling_7d: massS.rolling_7d},
      {color: COLORS.primary, height: 160});
    massArea.appendChild(legendRow([
      {color: COLORS.primary, label: "Daily"},
      {color: "#c4a04e", label: "7-day rolling avg"}
    ]));
    sec.appendChild(massArea);
  }

  // Body fat trend (if available)
  if (bfS && bfS.dates && bfS.values) {
    var bfArea = card("Body Fat Trend", [], "wide");
    areaChart(bfArea, {dates: bfS.dates, values: bfS.values, rolling_7d: bfS.rolling_7d},
      {color: COLORS.warning, height: 140});
    // Overlay lean mass if available and same date range
    if (lmS && lmS.dates && lmS.values) {
      bfArea.appendChild(legendRow([
        {color: COLORS.warning, label: "Body fat %"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    } else {
      bfArea.appendChild(legendRow([
        {color: COLORS.warning, label: "Body fat %"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    }
    sec.appendChild(bfArea);
  }

  // Lean mass trend (if available)
  if (lmS && lmS.dates && lmS.values) {
    var lmArea = card("Lean Body Mass Trend", [], "wide");
    areaChart(lmArea, {dates: lmS.dates, values: lmS.values, rolling_7d: lmS.rolling_7d},
      {color: COLORS.success, height: 140});
    lmArea.appendChild(legendRow([
      {color: COLORS.success, label: "Lean mass"},
      {color: "#c4a04e", label: "7-day rolling avg"}
    ]));
    sec.appendChild(lmArea);
  }

  knowledgePanel(sec, "body");
}

/* --- SLEEP --- */
function renderSleep(D) {
  var s = D.sleep;
  if (!s) return;
  var sec = section("sleep");
  sectionHeader(sec, "Sleep", s.nights_analyzed+" nights analyzed");

  var ds = s.duration_stats || {};

  // Hero stats row
  var grid = el("div", {className:"grid"});

  var heroCard = card("Duration");
  heroCard.appendChild(bigNum(fmt(ds.mean), "hrs avg",
    ds.trend_direction==="up"?"up":ds.trend_direction==="down"?"down":"flat", ds.trend_direction||"flat"));
  statsPanel(heroCard, ds, {decimals:1});
  grid.appendChild(heroCard);

  // Stage donut
  var sa = s.stage_averages;
  if (sa) {
    var donutCard = card("Sleep Stages");
    var donutWrap = el("div", {style:{display:"flex",alignItems:"center",gap:"20px",flexWrap:"wrap",justifyContent:"center"}});
    var dd = el("div");
    donutChart(dd, [
      {label:"Deep", value:sa.deep_pct||0, color:COLORS.sleep.deep},
      {label:"Core", value:sa.core_pct||0, color:COLORS.sleep.core},
      {label:"REM", value:sa.rem_pct||0, color:COLORS.sleep.rem},
      {label:"Awake", value:(sa.awake_min||0)/((sa.total_hrs||7)*60)*100, color:COLORS.sleep.awake}
    ], {size:180, centerLabel:fmt(sa.total_hrs,1)+"h"});
    donutWrap.appendChild(dd);
    donutWrap.appendChild(legendRow([
      {color:COLORS.sleep.deep, label:"Deep "+pct(sa.deep_pct)},
      {color:COLORS.sleep.core, label:"Core "+pct(sa.core_pct)},
      {color:COLORS.sleep.rem, label:"REM "+pct(sa.rem_pct)},
      {color:COLORS.sleep.awake, label:"Awake "+fmt(sa.awake_min,0)+"min"}
    ]));
    donutCard.appendChild(donutWrap);
    grid.appendChild(donutCard);
  }
  sec.appendChild(grid);

  // Duration area chart
  if (ds.dates && ds.values) {
    var areaCard = card("Nightly Duration", [], "wide");
    areaChart(areaCard, {dates:ds.dates, values:ds.values, rolling_7d:ds.rolling_7d}, {color:COLORS.secondary, height:170});
    areaCard.appendChild(legendRow([
      {color:COLORS.secondary, label:"Nightly"},
      {color:"#c4a04e", label:"7-day rolling avg"}
    ]));
    sec.appendChild(areaCard);
  }

  // Stage trends - stacked area
  var st = s.stage_trends;
  if (st && s.nightly && s.nightly.length > 0) {
    var stackCard = card("Sleep Stage Trends", [], "wide");
    var nightlyDates = s.nightly.map(function(n){return n.date});
    stackedArea(stackCard, [
      {name:"Deep", values:st.deep_pcts||[], color:COLORS.sleep.deep},
      {name:"Core", values:st.core_pcts||[], color:COLORS.sleep.core},
      {name:"REM", values:st.rem_pcts||[], color:COLORS.sleep.rem}
    ], {dates:nightlyDates, height:140});
    stackCard.appendChild(legendRow([
      {color:COLORS.sleep.deep, label:"Deep"},
      {color:COLORS.sleep.core, label:"Core"},
      {color:COLORS.sleep.rem, label:"REM"}
    ]));
    sec.appendChild(stackCard);
  }

  // Bedtime strip plot
  var bs = s.bedtime_stats;
  if (bs && bs.values_minutes && bs.values_minutes.length > 0) {
    var stripCard = card("Bedtime Distribution", [], "wide");
    var btVals = bs.values_minutes.map(function(m){ return m >= 1200 ? m - 1440 : m; });
    stripPlot(stripCard, btVals, {color:COLORS.secondary, minLabel:"8pm", maxLabel:"2am",
      min:-240, max:120});
    if (bs.stdev_minutes != null) {
      stripCard.appendChild(el("div", {style:{fontSize:".82rem",color:"#7b8090",marginTop:"8px"},
        textContent:"Bedtime variability: \u00b1"+fmt(bs.stdev_minutes,0)+" minutes (stdev)"}));
    }
    sec.appendChild(stripCard);
  }

  // Day-of-week heatmap
  var dow = ds.day_of_week;
  if (dow) {
    var heatCard = card("Sleep by Day of Week", [], "wide");
    var dayOrder = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    var dowData = dayOrder.map(function(d){ return {date:d, value:dow[d]||0}; });
    // Render as simple bar-like display
    var dowGrid = el("div", {style:{display:"flex",gap:"8px",flexWrap:"wrap",justifyContent:"center",margin:"12px 0"}});
    dayOrder.forEach(function(d){
      var v = dow[d];
      var color = v >= 7.5 ? COLORS.success : v >= 6.5 ? COLORS.primary : COLORS.warning;
      var di = el("div", {style:{textAlign:"center",minWidth:"50px"}});
      di.appendChild(el("div", {style:{fontSize:".72rem",color:"#6b7080",marginBottom:"4px"}, textContent:d}));
      di.appendChild(el("div", {style:{fontSize:"1.1rem",fontWeight:"300",color:color}, textContent:fmt(v,1)}));
      di.appendChild(el("div", {style:{fontSize:".65rem",color:"#5a6070"}, textContent:"hrs"}));
      dowGrid.appendChild(di);
    });
    heatCard.appendChild(dowGrid);
    sec.appendChild(heatCard);
  }

  // Duration histogram
  if (ds.distribution && ds.distribution.length > 0) {
    var histCard = card("Duration Distribution");
    histogram(histCard, ds.distribution, {color:COLORS.primary, labelDecimals:1});
    sec.appendChild(histCard);
  }

  // Wrist temperature during sleep
  var wtS = s.wrist_temp_stats;
  if (wtS && wtS.n > 0) {
    var wtCard = card("Sleeping Wrist Temperature", [], "wide");
    wtCard.appendChild(bigNum(fmt(wtS.mean, 2), "\u00b0C deviation"));
    if (wtS.dates && wtS.values) {
      areaChart(wtCard, {dates: wtS.dates, values: wtS.values, rolling_7d: wtS.rolling_7d},
        {color: COLORS.accent3, height: 130});
      wtCard.appendChild(legendRow([
        {color: COLORS.accent3, label: "Nightly"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    }
    statsPanel(wtCard, wtS, {decimals: 2});
    wtCard.appendChild(el("div", {className:"knowledge-panel", innerHTML:
      "<div class='kp-title'>About Wrist Temperature</div>" +
      "Wrist temperature during sleep can reflect changes in your body's circadian rhythm and metabolic activity. " +
      "Deviations from baseline may correlate with illness, ovulation, or environmental factors."}));
    sec.appendChild(wtCard);
  }

  knowledgePanel(sec, "sleep");
}

/* --- HEART --- */
function renderHeart(D) {
  var h = D.heart;
  if (!h) return;
  var sec = section("heart");
  sectionHeader(sec, "Heart Health", "Cardiovascular metrics and trends");

  var rhrS = h.resting_hr_stats || {};
  var hrvS = h.hrv_stats || {};

  // Hero cards
  var grid = el("div", {className:"grid"});

  var rhrCard = card("Resting Heart Rate");
  rhrCard.appendChild(bigNum(fmt(rhrS.mean,0), "bpm",
    rhrS.mean<=60?"up":rhrS.mean<=70?"flat":"warn",
    rhrS.mean<=60?"athletic":rhrS.mean<=70?"normal":"elevated"));
  statsPanel(rhrCard, rhrS, {decimals:0});
  grid.appendChild(rhrCard);

  var hrvCard = card("Heart Rate Variability");
  hrvCard.appendChild(bigNum(fmt(hrvS.mean,0), "ms",
    hrvS.mean>=50?"up":hrvS.mean>=30?"flat":"down",
    hrvS.mean>=50?"good":hrvS.mean>=30?"moderate":"low"));
  statsPanel(hrvCard, hrvS, {decimals:0});
  grid.appendChild(hrvCard);

  sec.appendChild(grid);

  // RHR horizon chart
  if (rhrS.values && rhrS.values.length > 0) {
    var hzCard = card("Resting HR \u2014 Horizon View", [], "wide");
    horizonChart(hzCard, rhrS.values, {height:60, upColor:COLORS.danger});
    if (rhrS.dates && rhrS.dates.length > 0) {
      var dateRow = el("div", {style:{display:"flex",justifyContent:"space-between",fontSize:".7rem",color:"#5a6070",marginTop:"4px"}});
      dateRow.appendChild(el("span", {textContent:(rhrS.dates[0]||"").slice(5)}));
      dateRow.appendChild(el("span", {textContent:(rhrS.dates[rhrS.dates.length-1]||"").slice(5)}));
      hzCard.appendChild(dateRow);
    }
    sec.appendChild(hzCard);
  }

  // Weekly RHR box plot
  var wRhr = h.weekly_resting_hr || [];
  if (wRhr.length > 2) {
    var bpCard = card("Weekly Resting HR Range", [], "wide");
    // Build box data from weekly aggregates + overall stats
    var boxes = wRhr.map(function(w){
      var avg = w.avg || 0;
      var spread = (rhrS.stdev || 3);
      return {
        label: w.week ? w.week.slice(5) : "",
        min: avg - spread*1.2,
        q1: avg - spread*0.5,
        median: avg,
        q3: avg + spread*0.5,
        max: avg + spread*1.2
      };
    });
    boxPlot(bpCard, boxes, {color:COLORS.danger});
    sec.appendChild(bpCard);
  }

  // HRV area chart
  if (hrvS.dates && hrvS.values) {
    var hrvArea = card("HRV Trend", [], "wide");
    areaChart(hrvArea, {dates:hrvS.dates, values:hrvS.values, rolling_7d:hrvS.rolling_7d},
      {color:COLORS.primary, height:160});
    hrvArea.appendChild(legendRow([
      {color:COLORS.primary, label:"Daily HRV"},
      {color:"#c4a04e", label:"7-day rolling avg"}
    ]));
    sec.appendChild(hrvArea);
  }

  // HR vs HRV scatter
  var scatter = h.hr_hrv_scatter || [];
  if (scatter.length > 3) {
    var scatCard = card("RHR vs HRV Relationship");
    var pts = scatter.map(function(d){ return {x:d.rhr, y:d.hrv, label:d.date}; });
    scatterPlot(scatCard, pts, {color:COLORS.info, trendLine:true,
      xLabel:"Resting HR (bpm)", yLabel:"HRV (ms)", height:240});
    sec.appendChild(scatCard);
  }

  // Day-of-week RHR radar
  if (rhrS.day_of_week) {
    var dowCard = card("RHR by Day of Week");
    var dayOrder = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    var dowAxes = dayOrder.map(function(d){
      var v = rhrS.day_of_week[d] || rhrS.mean || 60;
      return {label:d, value:v};
    });
    // Normalize for radar: map RHR range to 0-5 scale
    var rhrMin = Math.min.apply(null, dowAxes.map(function(a){return a.value}));
    var rhrMax = Math.max.apply(null, dowAxes.map(function(a){return a.value}));
    var rhrRange = rhrMax - rhrMin || 1;
    var normalizedAxes = dowAxes.map(function(a){
      return {label:a.label, value:1 + ((a.value-rhrMin)/rhrRange)*4};
    });
    radarChart(dowCard, normalizedAxes, {size:220, maxVal:5, fill:"rgba(179,107,107,0.12)", stroke:COLORS.danger});
    sec.appendChild(dowCard);
  }

  // VO2 Max
  var vo2S = h.vo2_max_stats;
  if (vo2S && vo2S.n > 0) {
    var vo2Card = card("VO2 Max", [], "wide");
    vo2Card.appendChild(bigNum(fmt(vo2S.mean, 1), "mL/kg/min",
      vo2S.mean >= 40 ? "up" : vo2S.mean >= 30 ? "flat" : "down",
      vo2S.mean >= 40 ? "good" : vo2S.mean >= 30 ? "fair" : "low"));
    if (vo2S.dates && vo2S.values) {
      areaChart(vo2Card, {dates: vo2S.dates, values: vo2S.values, rolling_7d: vo2S.rolling_7d},
        {color: COLORS.success, height: 140});
      vo2Card.appendChild(legendRow([
        {color: COLORS.success, label: "VO2 Max"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    }
    statsPanel(vo2Card, vo2S, {decimals: 1});
    vo2Card.appendChild(el("div", {className:"knowledge-panel", innerHTML:
      "<div class='kp-title'>About VO2 Max</div>" +
      "<strong>VO2 max</strong> measures the maximum rate of oxygen consumption during exercise and is widely considered " +
      "the best indicator of cardiorespiratory fitness. Higher values indicate better aerobic capacity. " +
      "Typical ranges are 30\u201360 mL/kg/min for adults, varying by age and sex. " +
      "Improvements are achievable through consistent aerobic training."}));
    sec.appendChild(vo2Card);
  }

  // Daily average heart rate
  var dhrS = h.daily_hr_stats;
  if (dhrS && dhrS.n > 0 && dhrS.dates && dhrS.values) {
    var dhrCard = card("Daily Average Heart Rate", [], "wide");
    dhrCard.appendChild(bigNum(fmt(dhrS.mean, 0), "bpm avg"));
    areaChart(dhrCard, {dates: dhrS.dates, values: dhrS.values, rolling_7d: dhrS.rolling_7d},
      {color: COLORS.accent2, height: 140});
    dhrCard.appendChild(legendRow([
      {color: COLORS.accent2, label: "Daily avg HR"},
      {color: "#c4a04e", label: "7-day rolling avg"}
    ]));
    statsPanel(dhrCard, dhrS, {decimals: 0});
    sec.appendChild(dhrCard);
  }

  knowledgePanel(sec, "heart");
}

/* --- ACTIVITY --- */
function renderActivity(D) {
  var a = D.activity;
  if (!a) return;
  var sec = section("activity");
  sectionHeader(sec, "Activity", "Steps, exercise, and energy expenditure");

  var stS = a.steps_stats || {};
  var exS = a.exercise_stats || {};
  var enS = a.energy_stats || {};

  // Hero grid
  var grid = el("div", {className:"grid-3"});

  var stCard = card("Daily Steps");
  stCard.appendChild(bigNum(fmt(stS.mean,0), "avg",
    stS.mean>=8000?"up":stS.mean>=5000?"flat":"down",
    stS.mean>=8000?"active":stS.mean>=5000?"moderate":"low"));
  if (stS.n) stCard.appendChild(el("div", {style:{fontSize:".78rem",color:"#6b7080"}, textContent:stS.n+" days"}));
  grid.appendChild(stCard);

  var exCard = card("Exercise");
  exCard.appendChild(bigNum(fmt(exS.mean,0), "min/day",
    exS.mean>=30?"up":exS.mean>=15?"flat":"down",
    exS.mean>=30?"strong":""));
  if (a.exercise_stats && a.exercise_stats.streak_any) {
    exCard.appendChild(el("div", {style:{fontSize:".78rem",color:COLORS.success}, textContent:a.exercise_stats.streak_any+"-day streak"}));
  }
  grid.appendChild(exCard);

  var enCard = card("Active Energy");
  enCard.appendChild(bigNum(fmt(enS.mean,0), "kcal/day"));
  grid.appendChild(enCard);
  sec.appendChild(grid);

  // Steps heatmap calendar
  if (stS.dates && stS.values) {
    var heatCard = card("Steps Calendar", [], "wide");
    var heatData = [];
    for (var i=0; i<stS.dates.length; i++) {
      heatData.push({date:stS.dates[i], value:stS.values[i]});
    }
    heatmapGrid(heatCard, heatData, {cellSize:14});
    heatCard.appendChild(legendRow([
      {color:COLORS.heatmap[1], label:"Low"},
      {color:COLORS.heatmap[3], label:"Moderate"},
      {color:COLORS.heatmap[5], label:"High"}
    ]));
    sec.appendChild(heatCard);
  }

  // Exercise lollipop
  if (exS.dates && exS.values) {
    var lollCard = card("Exercise Minutes", [], "wide");
    lollipopChart(lollCard, {dates:exS.dates, values:exS.values}, {color:COLORS.info, height:130});
    sec.appendChild(lollCard);
  }

  // Energy area chart
  if (enS.dates && enS.values) {
    var aeCard = card("Active Energy Trend", [], "wide");
    areaChart(aeCard, {dates:enS.dates, values:enS.values, rolling_7d:enS.rolling_7d},
      {color:COLORS.warning, height:140});
    sec.appendChild(aeCard);
  }

  // Day-of-week grouped bar
  if (stS.day_of_week && exS.day_of_week) {
    var dowCard = card("Activity by Day of Week", [], "wide");
    var dayOrder = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    var stepVals = dayOrder.map(function(d){return stS.day_of_week[d]||0});
    var exVals = dayOrder.map(function(d){return (exS.day_of_week[d]||0)*100}); // scale up for visibility
    groupedBar(dowCard, dayOrder, [
      {name:"Steps", values:stepVals, color:COLORS.primary},
      {name:"Exercise\u00d7100", values:exVals, color:COLORS.info}
    ], {height:150});
    dowCard.appendChild(legendRow([
      {color:COLORS.primary, label:"Steps"},
      {color:COLORS.info, label:"Exercise min \u00d7100"}
    ]));
    sec.appendChild(dowCard);
  }

  // Steps histogram
  if (stS.distribution && stS.distribution.length > 0) {
    var histCard = card("Steps Distribution");
    histogram(histCard, stS.distribution, {color:COLORS.success, labelDecimals:0});
    sec.appendChild(histCard);
  }

  // Consistency gauge
  if (stS.cv != null) {
    var gCard = card("Step Consistency");
    var consistency = Math.max(0, 100 - stS.cv * 200);
    gaugeChart(gCard, consistency, {label:"Consistency Score", size:150});
    sec.appendChild(gCard);
  }

  // Detailed stats
  var detCard = card("Detailed Statistics", [], "wide");
  statsPanel(detCard, stS, {decimals:0});
  sec.appendChild(detCard);

  // Flights climbed
  var flS = a.flights_stats;
  if (flS && flS.n > 0) {
    var flCard = card("Flights Climbed", [], "wide");
    flCard.appendChild(bigNum(fmt(flS.mean, 1), "flights/day"));
    if (flS.dates && flS.values) {
      lollipopChart(flCard, {dates: flS.dates, values: flS.values}, {color: COLORS.accent3, height: 130});
    }
    statsPanel(flCard, flS, {decimals: 1});
    sec.appendChild(flCard);
  }

  // Stand time
  var standS = a.stand_time_stats;
  if (standS && standS.n > 0) {
    var standCard = card("Stand Time", [], "wide");
    standCard.appendChild(bigNum(fmt(standS.mean, 0), "min/day"));
    if (standS.dates && standS.values) {
      areaChart(standCard, {dates: standS.dates, values: standS.values, rolling_7d: standS.rolling_7d},
        {color: COLORS.info, height: 130});
      standCard.appendChild(legendRow([
        {color: COLORS.info, label: "Daily stand time"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    }
    statsPanel(standCard, standS, {decimals: 0});
    sec.appendChild(standCard);
  }

  // Basal energy
  var basalS = a.basal_energy_stats;
  if (basalS && basalS.n > 0) {
    var basalCard = card("Basal Energy Burn");
    basalCard.appendChild(bigNum(fmt(basalS.mean, 0), "kcal/day"));
    statsPanel(basalCard, basalS, {decimals: 0});
    sec.appendChild(basalCard);
  }

  knowledgePanel(sec, "activity");
}

/* --- RESPIRATORY --- */
function renderRespiratory(D) {
  var r = D.respiratory;
  if (!r) return;
  var sec = section("respiratory");
  sectionHeader(sec, "Respiratory", "Breathing rate and blood oxygen");

  var rrS = r.respiratory_rate_stats;
  var spS = r.spo2_stats;

  if (rrS) {
    var grid = el("div", {className:"grid"});
    var rrCard = card("Respiratory Rate");
    rrCard.appendChild(bigNum(fmt(rrS.mean,1), "br/min"));
    statsPanel(rrCard, rrS, {decimals:1});
    grid.appendChild(rrCard);

    if (spS) {
      var spCard = card("Blood Oxygen (SpO2)");
      spCard.appendChild(bigNum(fmt(spS.mean,1), "%"));
      statsPanel(spCard, spS, {decimals:1});
      grid.appendChild(spCard);
    }
    sec.appendChild(grid);

    // RR area chart with range band
    if (rrS.dates && rrS.values) {
      var aCard = card("Respiratory Rate Trend", [], "wide");
      areaChart(aCard, {dates:rrS.dates, values:rrS.values, rolling_7d:rrS.rolling_7d},
        {color:COLORS.info, height:140});
      sec.appendChild(aCard);
    }

    // SpO2 strip plot
    if (spS && spS.values && spS.values.length > 0) {
      var spCard2 = card("SpO2 Distribution", [], "wide");
      stripPlot(spCard2, spS.values, {color:COLORS.success, min:90, max:100, minLabel:"90%", maxLabel:"100%"});
      sec.appendChild(spCard2);
    }
  }

  knowledgePanel(sec, "respiratory");
}

/* --- MOBILITY --- */
function renderMobility(D) {
  var m = D.mobility;
  if (!m) return;
  var sec = section("mobility");
  sectionHeader(sec, "Mobility", "Gait and movement quality");

  var wsS = m.walking_speed_stats;
  var slS = m.step_length_stats;
  var asS = m.asymmetry_stats;

  var grid = el("div", {className:"grid"});

  if (wsS) {
    var wsCard = card("Walking Speed");
    wsCard.appendChild(bigNum(fmt(wsS.mean,2), "m/s"));
    statsPanel(wsCard, wsS, {decimals:2});
    grid.appendChild(wsCard);
  }

  if (slS) {
    var slCard = card("Step Length");
    slCard.appendChild(bigNum(fmt(slS.mean,2), "m"));
    statsPanel(slCard, slS, {decimals:2});
    grid.appendChild(slCard);
  }

  if (asS) {
    var asCard = card("Asymmetry");
    asCard.appendChild(bigNum(fmt(asS.mean,1), "%"));
    var color = asS.mean < 5 ? COLORS.success : asS.mean < 10 ? COLORS.warning : COLORS.danger;
    asCard.appendChild(el("div", {style:{fontSize:".82rem",color:color,marginTop:"4px"},
      textContent:asS.mean<5?"Normal range":"Elevated \u2014 consider evaluation"}));
    grid.appendChild(asCard);
  }
  sec.appendChild(grid);

  // Walking speed area
  if (wsS && wsS.dates && wsS.values) {
    var wsArea = card("Walking Speed Trend", [], "wide");
    areaChart(wsArea, {dates:wsS.dates, values:wsS.values, rolling_7d:wsS.rolling_7d},
      {color:COLORS.success, height:130});
    sec.appendChild(wsArea);
  }

  // Step length histogram
  if (slS && slS.distribution && slS.distribution.length > 0) {
    var histCard = card("Step Length Distribution");
    histogram(histCard, slS.distribution, {color:COLORS.info, labelDecimals:2});
    sec.appendChild(histCard);
  }

  // Stair speeds (ascent vs descent)
  var saS = m.stair_ascent_stats;
  var sdS = m.stair_descent_stats;
  if ((saS && saS.n > 0) || (sdS && sdS.n > 0)) {
    var stairCard = card("Stair Speed", [], "wide");

    // Use grouped bar if we have day-of-week data for both, otherwise show dual trends
    if (saS && sdS && saS.dates && saS.values && sdS.dates && sdS.values) {
      // Dual area overlay  ascent and descent on same chart
      var stairWrap = el("div");
      areaChart(stairWrap, {dates: saS.dates, values: saS.values, rolling_7d: saS.rolling_7d},
        {color: COLORS.primary, height: 130});
      stairCard.appendChild(stairWrap);
      // Overlay descent as a second card section to avoid chart overlap complexity
      var descWrap = el("div", {style:{marginTop:"8px"}});
      areaChart(descWrap, {dates: sdS.dates, values: sdS.values, rolling_7d: sdS.rolling_7d},
        {color: COLORS.accent2, height: 130});
      stairCard.appendChild(descWrap);
      stairCard.appendChild(legendRow([
        {color: COLORS.primary, label: "Ascent (floors/min)"},
        {color: COLORS.accent2, label: "Descent (floors/min)"}
      ]));
    }

    var stairGrid = el("div", {className:"grid"});
    if (saS && saS.n > 0) {
      var saCard = card("Stair Ascent Speed");
      saCard.appendChild(bigNum(fmt(saS.mean, 2), "floors/min"));
      statsPanel(saCard, saS, {decimals: 2});
      stairGrid.appendChild(saCard);
    }
    if (sdS && sdS.n > 0) {
      var sdCard2 = card("Stair Descent Speed");
      sdCard2.appendChild(bigNum(fmt(sdS.mean, 2), "floors/min"));
      statsPanel(sdCard2, sdS, {decimals: 2});
      stairGrid.appendChild(sdCard2);
    }
    stairCard.appendChild(stairGrid);
    sec.appendChild(stairCard);
  }

  // Double support percentage
  var dsS = m.double_support_stats;
  if (dsS && dsS.n > 0) {
    var dsCard = card("Double Support Time", [], "wide");
    dsCard.appendChild(bigNum(fmt(dsS.mean, 1), "% of gait cycle"));
    if (dsS.dates && dsS.values) {
      areaChart(dsCard, {dates: dsS.dates, values: dsS.values, rolling_7d: dsS.rolling_7d},
        {color: COLORS.accent3, height: 130});
      dsCard.appendChild(legendRow([
        {color: COLORS.accent3, label: "Double support %"},
        {color: "#c4a04e", label: "7-day rolling avg"}
      ]));
    }
    statsPanel(dsCard, dsS, {decimals: 1});
    sec.appendChild(dsCard);
  }

  // Walking steadiness
  var stS2 = m.steadiness_stats;
  if (stS2 && stS2.n > 0 && stS2.values && stS2.values.length > 0) {
    var stCard = card("Walking Steadiness", [], "wide");
    stCard.appendChild(bigNum(fmt(stS2.mean, 0), "%"));
    stripPlot(stCard, stS2.values, {color: COLORS.success, min: 0, max: 100, minLabel: "0%", maxLabel: "100%"});
    statsPanel(stCard, stS2, {decimals: 0});
    sec.appendChild(stCard);
  }

  knowledgePanel(sec, "mobility");
}

/* --- INTERCONNECTIONS --- */
function renderInterconnections(D) {
  var ic = D.interconnections;
  if (!ic) return;
  var sec = section("interconnections");
  sectionHeader(sec, "Interconnections", "How your health metrics relate to each other");

  // Correlation matrix heatmap
  if (ic.matrix && ic.metric_names && ic.metric_names.length > 0) {
    var matCard = card("Correlation Matrix", [], "wide");
    heatmapGrid(matCard, {matrix:ic.matrix, metric_names:ic.metric_names}, {matrixMode:true, cellSize:48});
    matCard.appendChild(el("div", {style:{display:"flex",justifyContent:"center",gap:"16px",marginTop:"12px",fontSize:".75rem",color:"#6b7080"}},[
      el("span", {innerHTML:"<span style='display:inline-block;width:12px;height:12px;background:"+COLORS.correlation.negative+";border-radius:2px;vertical-align:middle;margin-right:4px'></span>Negative"}),
      el("span", {innerHTML:"<span style='display:inline-block;width:12px;height:12px;background:"+COLORS.correlation.zero+";border-radius:2px;vertical-align:middle;margin-right:4px'></span>None"}),
      el("span", {innerHTML:"<span style='display:inline-block;width:12px;height:12px;background:"+COLORS.correlation.positive+";border-radius:2px;vertical-align:middle;margin-right:4px'></span>Positive"})
    ]));
    sec.appendChild(matCard);
  }

  // Top correlations scatter plots
  var top = ic.top_correlations || [];
  if (top.length > 0) {
    var topCard = card("Strongest Correlations", [], "wide");
    var topTbl = el("table", {className:"data-table"});
    topTbl.appendChild(el("thead", {}, [el("tr", {}, [
      el("th", {textContent:"Metric A"}), el("th", {textContent:"Metric B"}),
      el("th", {textContent:"r"}), el("th", {textContent:"p-value"}), el("th", {textContent:"n"})
    ])]));
    var tbody = el("tbody");
    top.forEach(function(c){
      var absR = Math.abs(c.r);
      var rColor = absR > 0.5 ? COLORS.success : absR > 0.3 ? COLORS.warning : COLORS.muted;
      tbody.appendChild(el("tr", {}, [
        el("td", {textContent:(c.metric_a||"").replace(/-/g," ")}),
        el("td", {textContent:(c.metric_b||"").replace(/-/g," ")}),
        el("td", {style:{color:rColor,fontWeight:"500"}, textContent:fmt(c.r,3)}),
        el("td", {textContent:c.p!=null?c.p.toFixed(4):"--"}),
        el("td", {textContent:c.n||"--"})
      ]));
    });
    topTbl.appendChild(tbody);
    topCard.appendChild(el("div", {className:"table-wrap"}, [topTbl]));
    sec.appendChild(topCard);
  }

  knowledgePanel(sec, "interconnections");
}

/* --- METHODOLOGY --- */
function renderMethodology(D) {
  var m = D.methodology;
  if (!m) return;
  var sec = section("methodology");
  sectionHeader(sec, "Methodology", "How this report was generated");

  var methCard = card(null, [], "wide");
  var items = [
    {label:"Metrics Analyzed", value:m.metrics_analyzed||"--"},
    {label:"Period Length", value:(m.days_in_period||"--")+" days"},
    {label:"Generated", value:m.generated_at||"--"},
    {label:"Statistical Methods", value:"Descriptive statistics, Pearson correlations, rolling averages, z-score anomaly detection"},
    {label:"Scoring", value:"0-5 scale based on percentile rank within population norms and personal baselines"},
    {label:"Confidence", value:"Results are more reliable with 30+ days of consistent data"}
  ];
  items.forEach(function(item){
    var row = el("div", {className:"meth-item"});
    row.appendChild(el("div", {className:"meth-label", textContent:item.label}));
    row.appendChild(el("div", {className:"meth-value", textContent:item.value}));
    methCard.appendChild(row);
  });
  sec.appendChild(methCard);

  // Disclaimer
  var disc = el("div", {style:{marginTop:"24px",padding:"16px 20px",background:"#0d0e14",border:"1px solid #1c1e26",
    borderRadius:"12px",fontSize:".8rem",color:"#5a6070",lineHeight:"1.7"}});
  disc.innerHTML = "<strong style='color:#6b7080'>Disclaimer:</strong> This report is generated from Apple Health data for personal insight only. "+
    "It is not a medical diagnosis. Consult a healthcare professional for medical advice. "+
    "Statistical correlations do not imply causation. Data quality depends on device accuracy and wearing consistency.";
  sec.appendChild(disc);
}

/* =============================================
   DISPATCH
   ============================================= */
if (MODE === 'report') {
  try {
    renderHeader(D);
    renderExecutiveSummary(D);
    if (D.vitals) renderVitals(D);
    if (D.body) renderBody(D);
    if (D.sleep) renderSleep(D);
    if (D.heart) renderHeart(D);
    if (D.activity) renderActivity(D);
    if (D.respiratory) renderRespiratory(D);
    if (D.mobility) renderMobility(D);
    renderInterconnections(D);
    renderMethodology(D);
  } catch(e) {
    app.appendChild(el("div", {style:{color:COLORS.danger,padding:"40px",fontSize:"1rem"},
      textContent:"Render error: " + e.message + " at " + (e.stack||"").split("\n")[1]}));
  }
} else {
  app.appendChild(el("div", {style:{color:COLORS.warning,padding:"40px"},
    textContent:"Unknown mode: "+MODE+". This template handles mode='report'."}));
}

})();
</script>
</body>
</html>
